import { getCookie } from './utils/auth'
import { removeStart } from './utils/index'
import 'nprogress/nprogress.css'
import NProgress from 'nprogress'
import store from './store'


let moduleMap;
function parseModule(url){
  if(!moduleMap){
    moduleMap = {};
    JSON.parse(process.env.VUE_APP_MODULES).forEach(m => {
      moduleMap[m.module] = m;
    });
  }
  let name = removeStart(url, '/').split('/')[0];
  if(name && moduleMap[name]){
    return name;
  }
  return ''
}

NProgress.configure({ easing: 'ease', speed: 500, showSpinner: false });
export default function accessFilter(router){
  router.beforeEach(function(to, from, next){
    NProgress.start()
    const fromModule = parseModule(from.path), toModule = parseModule(to.path);
    // if( process.env.NODE_ENV == 'development'){
    //   console.log(from, to)
    // }
    if(!to.matched){
      window.location.replace('/error/404');
    }else if(from.matched.length && fromModule != toModule){//不是同一个模块 跳转到目标模块
      window.location.href = router.resolve(to).href;
    }else { // 鉴权
      let access = to.meta && to.meta.access;
      if(access != 'login' && access != 'auth'){
        next()
        NProgress.done()
      }else if (!getCookie('X-Commnet-Token')){
        //未登录 跳转登录页
        if(fromModule == 'login'){
          next({ path: '/login', query: { redirect: to.fullPath }, replace: true })
          NProgress.done()
        }else{
          let url = router.resolve('/login').href;
          window.location.replace(url + '?redirect=' + encodeURIComponent(to.fullPath));
        }
      }else if(access == 'login'){
        //页面权限为登录
        next()
        NProgress.done()
      }else{
        store.getters.asyncPermit(to.matched.slice(-1)[0].path, 1).then((hasPermit) => {
          if(hasPermit){ //验证授权通过
            next()
          }else{
            window.location.replace('/error/403');
          }
        }).catch(error => {
          window.location.replace('/error/403');
        }).finally(() => {
          NProgress.done()
        })
      }
    }
  });
}
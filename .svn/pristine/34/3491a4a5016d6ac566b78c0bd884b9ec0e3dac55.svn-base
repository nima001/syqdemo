<template>
  <div ref="content" :class="['ring-chart', {'border': isDrag}]" @mousedown.prevent="allowMove?move():false">
    <h2 v-if="mainTitle.visible!==false||title" :style="{ textAlign: position||'center' }" v-html="mainTitle.value||title"/>
    <h3 v-if="subTitle.visible!==false||subtitle" :style="{ margin: 0, textAlign: position||'center' }" v-html="subTitle.value||subtitle"/>
    <div ref="chart" class="chart"></div>
    <slot name="customLegend" v-bind="colors"></slot>
    <div class="tag" v-if="allowDrag" @mousedown.stop.prevent="drag()"/>
  </div>
</template>
<script>
import * as G2 from "@antv/g2";
import BaseMixin from "./BaseMixin";
import { get, orderBy, xor, reduce, map, has, groupBy, keys } from "lodash";
import { delTemplate } from "../../api/booklet";
import ChartConsoleVue from '../../views/statistics/chart/ChartConsole.vue';
import ContentSelectVue from '../../views/statistics/analysis/components/ContentSelect.vue';

export default {
  icon: "chart-ring",
  title: "饼图",
  name: "RingChart",
  mixins: [BaseMixin],
  data() {
    return {
      currentMoveX: 0,
      currentMoveY: 0,
      isDrag: false,
      isMove: false,
      plot: undefined,
      lastItem: undefined,
      innerView: undefined,
    };
  },
  mounted() {
    this.draw(this.data);
  },
  computed: {
		title(){
			let { title, context = {}} = this.settings;
			if(title&&typeof title=='string'){
				for(let key in context){
					title = title.replace(new RegExp('\\$\\{' + key + '\\}', 'g'), context[key]);
				}
				return title;
			}
			return undefined;
		},
		subtitle() {
			let { subtitle, context = {}} = this.settings;
			if(subtitle&&typeof title=='string'){
				for(let key in context){
					subtitle = subtitle.replace(new RegExp('\\$\\{' + key + '\\}', 'g'), context[key]);
				}
				return subtitle;
			}
			return undefined;
		},
		muitl(){
			if(this.data){
			  let { keyCols, valueCols, rows } = this.data;
			  return valueCols.length > 1 || keyCols.length > 1;
			}
		},
		sortType() {
      if(this.settings.sort) {
        let { type } = this.settings.sort;
        if(type=='asc'||type=='desc') {
          return type;
        }
      }
			return undefined;
		},
    position() {
      if(this.settings.title&&this.settings.title.position) {
        let { position } = this.settings.title;
        return position;
      }else{
        return undefined
      }
    },
    mainTitle() {
      if(this.settings.title&&this.settings.title.main) {
        let { main } = this.settings.title;
        if(!main) {
          return  {
            visible: true,
            value: undefined,
          }
        }
        if(!has(main,'visible')) {
          main.visible = true;
        }
        return main;
      }else{
        return {
          main: {
            visible: true,
            value: undefined,
          }
        }
      }
    },
    subTitle() {
      if(this.settings.title&&this.settings.title.sub) {
        let { sub } = this.settings.title;
        if(!sub) {
          return  {
            visible: true,
            value: undefined,
          }
        }
        if(!has(sub,'visible')) {
          sub.visible = true;
        }
        return sub;
      }else{
        return {
          sub: {
            visible: true,
            value: undefined,
          }
        }
      }
    },
    label() {
      if(this.settings.gemo) {
        let { label } = this.settings.gemo;
        return label;
      }else{
        return {
          visible: true
        }
      }
    },
    legend() {
      let { legend } = this.settings;
      if(!legend) {
        return  {
          visible: false,
        }
      }
      return legend;
    },
    tooltip() {
      let { tooltip } = this.settings;
      if(!tooltip) {
        return  {
          visible: true,
        }
      }
      return tooltip;
    },
    format() {
      if(this.tooltip) {
        let { format } = this.tooltip;
        if(format) {
          if(!format.unit) {
            format.unit = '';
          }
          if(!format.toFixed) {
            format.toFixed = 0;
          }
          return format;
        }
      }
      return {
        unit: '',
        toFixed: 0,
      };
    },
    color() {
      let { color } = this.settings.gemo;
      return color;
    },
    colors() {
      if (this.color&&(this.color.length||typeof this.color==='string')) {
        if(typeof this.color==='string') {
          return this.color.split(',');
        }
        return this.color;
      } else {
        let colors = this.$store.getters.getConfig("chart.colors");
        if (colors) {
          try {
            colors = JSON.parse(colors);
            if (colors && colors.length) {
              return colors;
            }
          } catch (err) {}
        }
      }
      return ["#D15456", "#5488D1", "#EDBA55", "#D48265", "#91C7AE", "#749F83", "#BDA29A", "#6E7074", "#585470", "#706254"];
    },
  },
  watch: {
    data: {
      handler(v) {
        this.draw(v);
      },
      deep: true,
    },
    settings: {
      deep: true,
      handler(val,old) {
        if(val != old) {
          this.draw(this.data)
        }
      },
    },
  },
  methods: {
    move() {
      let that = this;
      //获取x坐标和y坐标
      let startX = event.clientX;
      let startY = event.clientY;
      //获取左部和顶部的偏移量
      let left = that.$refs.content.offsetLeft;
      let top = that.$refs.content.offsetTop;
      this.isMove = true;
      let timer = setTimeout(()=>{
        document.onmousemove = function (e) {
          let endX = e.clientX;
          let endY = e.clientY;
          if(endX!=startX) {
            that.$refs.content.style.left = endX-(startX-left)+'px';
          }
          if(endY!=startY) {
            that.$refs.content.style.top =  endY-(startY-top)+'px';
          }
        }
      },300);
      document.onmouseup = function () {
        clearInterval(timer);
        this.isMove = false;
        document.onmousemove = null;
        document.onmouseup = null;
      };
      return false;
    },
    drag() {
      let that = this;
      let startX = event.x;
      let startY = event.y;
      let width = that.$refs.content.offsetWidth;
      let height = that.$refs.content.offsetHeight;
      that.isDrag = true;
      document.onmousemove = function (e) {
        let moveX = e.pageX - startX;
        let moveY = e.pageY - startY;
        if(that.currentMoveX!=event.x&&moveX!=0) {
          that.$refs.content.style.width = Math.min(1400, Math.max(300, moveX+width))+'px';
          that.currentMoveX = event.x;
        }
        if(that.currentMoveY!=event.y&&moveY!=0) {
          that.$refs.content.style.height = Math.min(1400, Math.max(200, moveY+height))+'px';
          that.currentMoveY = event.y;
        }
      };
      document.onmouseup = function () {
        that.draw(that.data)
        that.isDrag = false;
        document.onmousemove = null;
        document.onmouseup = null;
      };
      return false;
    },
    sum(list) {
      let sum = 0;
      if(list) {
        list.forEach((item) => {
          sum += parseInt(item.value);
        });
      }
      return sum;
    },
    createData(dataTable) {
      if (!dataTable) {
        return;
      }
      let { keyCols, valueCols, rows } = this.transform(dataTable);
      let row = rows;
      //截取
      if(this.settings.sort&&this.settings.sort.range&&this.settings.sort.range.length) {
        rows = rows.slice(this.settings.sort.range[0],this.settings.sort.range[1]);
      }
      //合并
      if(this.settings.sort&&this.settings.sort.mergeOther) {
        let xors = xor(row, rows);
        let sum = reduce(map(xors,'v0')||0,(sum,n)=>{
          return sum+n;
        });
        rows.push({k0:'剩余',v0:sum});
      }
      let newRows = this.getRows(rows,keyCols,valueCols);
      if(this.sortType) {
        return orderBy(newRows,'value',this.sortType);
      }else{
        return newRows;
      } 
    },
    getRows(rows,keyCols,valueCols) {
      return rows.map((item) => {
        let keys = keyCols.map((k) => item[k.column]);
        return {
          key: keys.join("-"),
          value: item[valueCols[0].column] || 0,
        };
      });
    },
    draw(dataTable) {
      let data = this.createData(dataTable);
      let sum = this.sum(data);
      if (!data) {
        return;
      }
      if (this.plot) {
        this.plot.destroy();
      }
      const chart = new G2.Chart({
        container: this.$refs.chart,
        autoFit: true,
        forceFit: true,
        appendPadding: this.settings.padding || [0, 0, 0, 0],
      });
      // 新建一个 view 用来单独渲染Annotation
      this.innerView = chart.createView();
      let radius = 0.7;
      let innerRadius = 0.6;
      if(this.settings.radius) {
        radius = this.settings.radius;
      }
      if(this.settings.innerRadius) {
        innerRadius = this.settings.innerRadius;
      }
      chart.coordinate("theta", {
        radius: radius,
        innerRadius: innerRadius,
      });
      chart.data(data);
      //提示
      chart.tooltip({
        showTitle: false,
        showMarkers: false,
      });
      if (this.tooltip) {
        if (!this.tooltip.visible) {
          chart.tooltip(false);
        }
      }
      // 配置图例
      chart.legend(false);
      if (this.legend) {
        if (this.legend.visible) {
           chart.legend({
            layout: this.legend.layout||'horizontal',
            offsetX: this.legend.offsetX,
            offsetY: this.legend.offsetY,
            position: this.legend.position,
            flipPage: this.legend.flipPage,
            position: this.legend.position,
            flipPage: this.legend.flipPage,
            itemHeight: 15,
            itemName: {
              style: this.legend.style
            },
            marker: {
              symbol: this.legend.marker,
            },
          });
        }
      }
      let geometry = chart.interval();
      //是否显示label
      if (this.label&&this.label.visible) {
        geometry.label("key*value", {
          layout: [{ type: "pie-spider" }, { type: "hide-overlap" }],
          content: (obj) => `${obj.key}:  ${obj.value}`,
          style: {
            fill: this.label.color,
          },
          content: (v)=> {
            return v.value.toFixed(that.format.toFixed)
          }
        });
      } else {
        geometry.label(false); //FIXME 值太多默认不显示
      }

      let that = this;
      geometry
        .adjust("stack")
        .position("value")
        .color("key", this.colors)
        .shape('slice-shape')
        .tooltip('key*value',function (key,value) {
          return {
            name: key,
            value: value.toFixed(that.format.toFixed) + that.format.unit
          }
        })
        .state({
          active: {
            style: element => {
              const shape = element.shape;
              return {
                lineWidth: 8,
                stroke: shape.attr('fill'),
                strokeOpacity: shape.attr('fillOpacity'),
              };
            },
          },
        }); 
      chart.interaction('element-active');
      //初始化标注
      this.Annotation(chart, data, sum);  
      //标注的交互
      this.itemHover(chart, data, sum);
      chart.changeData(data);
      this.plot = chart;
    },
    itemHover(chart, data, sum) {
      chart.on("element:statechange", (ev) => {
        const { state, stateStatus, element } = ev.gEvent.originalEvent;
        if(state === 'active') {
          if(stateStatus) {
            const dataText = element.getData();
            let title = dataText.key;
            let content = ((dataText.value/sum)*100).toFixed(0)+'%';
            this.updateAnnotation(chart, title, content,dataText);
            this.lastItem = dataText;
            this.innerView.render(true);
          }
        }
      });
    },
    //更新 annotation
    updateAnnotation(chart, title, content,dataText) {
      if(dataText !== this.lastItem) {
        let style,contentStyle,offsetY,contentOffsetY = undefined;
        if(this.settings.infoText&&this.settings.infoText.style) {
          style = this.settings.infoText.style;
        }else{
          style={
            fontSize: 20, 
            fill: '#000', 
            textAlign: 'center'
          } 
        }
        if(this.settings.contentStyle) {
          contentStyle = this.settings.contentStyle;
        }else{
          contentStyle= {
            fontSize: 25,
            fill: '#000', 
            textAlign: 'center'
          }
        }
        if(this.settings.infoText&&this.settings.infoText.offsetY) {
          offsetY = this.settings.infoText.offsetY;
        }else{
          offsetY = -20;
        }
        if(this.settings.contentStyle&&this.settings.contentStyle.offsetY) {
          contentOffsetY = this.settings.contentStyle.offsetY;
        }else{
          contentOffsetY = 10;
        }
        if(title.length>4) {
          title = title.slice(0,4)+'...';
        }
        this.innerView.annotation().clear(true);
        this.innerView
          .annotation()
          .text({
            position: ['50%', '50%'],
            content: title,
            style: style,
            offsetY: offsetY,
          })
          .text({
            position: ['50%', '50%'],
            content: content,
            style: contentStyle,
            offsetY: contentOffsetY,
          });
      }
    },
    //首次显示annotation
    Annotation(chart, data, sum) {
      // 辅助文本
      let title,total,style,contentStyle,offsetY,contentOffsetY = undefined;
      if(this.settings.infoText&&this.settings.infoText.title) {
        title = this.settings.infoText.title;
        if(title.length>4) {
          title = title.slice(0,4)+'...';
        }
        let obj = data.filter(item=>item.key==this.settings.infoText.title);
        if(obj.length) {
          if(sum!==0) {
            total = ((obj[0].value/reduce(map(data, "value"),(sum,n)=>{return sum+n}))*100).toFixed(0)+'%';
          }else{
            total = '0%';
          }
        }
      }else{
        total = reduce(map(data, "value"),(sum,n)=>{return sum+n});
      }
      if(this.settings.infoText&&this.settings.infoText.style) {
        style = this.settings.infoText.style;
      }else{
        style={
          fontSize: 20, 
          fill: '#000', 
          textAlign: 'center'
        } 
      }
      if(this.settings.contentStyle) {
        contentStyle = this.settings.contentStyle;
      }else{
        contentStyle= {
          fontSize: 25,
          fill: '#000', 
          textAlign: 'center'
        }
      }
      if(this.settings.infoText&&this.settings.infoText.offsetY) {
        offsetY = this.settings.infoText.offsetY;
      }else{
        offsetY = -20;
      }
      if(this.settings.contentStyle&&this.settings.contentStyle.offsetY) {
        contentOffsetY = this.settings.contentStyle.offsetY;
      }else{
        contentOffsetY = 10;
      }
      this.innerView.annotation().clear(true);
      this.innerView
      .annotation()
      .text({
        position: ['50%', '50%'],
        content:  title||'合计',
        style: style,
        offsetY: offsetY,
      })
      .text({
        position: ['50%', '50%'],
        content: total,
        style: contentStyle,
        offsetY: contentOffsetY,
      });
    }
  },
};
</script>
<style lang="less" scoped>
.ring-chart {
  width: 100%;
  height: 400px;
  display: flex;
  flex-direction: column;
  position: relative;
  &.border {
    border: 1px dashed #000;
  }
  /deep/.chart {
    display: flex;
    div {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
  .tag {
    position: absolute;
    right: -10px;
    bottom: -10px;
    border-right: 5px solid #979797;
    height: 14px;
    border-bottom: 5px solid #979797;
    width: 14px;
    cursor: nw-resize;
  }
  h2 {
    margin: 0;
  }
  div {
    flex: 1;
  }
}
</style>

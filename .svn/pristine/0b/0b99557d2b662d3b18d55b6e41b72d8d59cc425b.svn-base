<template>
  <div class="report-chart-panel">
    <div class="left">
      <div class="title">数据集</div>
      <div class="data-set">
        <a-input :value="chartData.query && chartData.query.title" :read-only="false">
          <a slot="addonAfter" @click="showQueryModal = true">编辑</a>
        </a-input>
      </div>
      <div class="title">
        维度
        <a-tooltip placement="right">
          <a-icon type="question-circle"/>
          <span slot="title">按什么统计</span>
        </a-tooltip>
      </div>
      <ul class="dimension">
        <li v-for="item in dimension" :key="item.key"
          @click="onDimensionClick(item)"
        >
          <custom-icon :type="item.icon"/>
          <span>{{item.showname}}</span>
        </li>
      </ul>
      <div class="title">
        指标
        <a-tooltip placement="right">
          <a-icon type="question-circle"/>
          <span slot="title">统计的数据</span>
        </a-tooltip>
      </div>
      <ul class="measure">
        <li v-for="item in measure" :key="item.key"
           @click="onMeasureClick(item)"
        >
          <custom-icon :type="item.icon"/>
          <span>{{item.showname}}</span>
        </li>
      </ul>
      <div class="title">图表类型</div>
      <div class="graph">
        <ul>
          <li v-for="item in chartTypes" :key="item.type">
            <div class="item">
              <div :class="{
                'chart-type': true,
                'selected': item.type == chartType
              }" @click="chartType=item.type"><a-icon :type="item.icon"/></div>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <div class="content">
      <div class="header">
        <div class="axis">
          <div class="title">横轴</div>
          <draggable
            v-model="groupWith" 
            tag="ul"
            :animation="200"
          >
            <transition-group>
              <dimension v-for="(item, index) in groupWith" 
                :key="item.id"
                v-model="groupWith[index]"
                :field="item.key && fieldMap[item.key]"
                :measures="$refs.measure"
                @remove="onDimensionRemove(index)"
              />
            </transition-group>
          </draggable>
        </div>
        <div class="axis">
          <div class="title">纵轴</div>
          <draggable
            v-model="groupField" 
            tag="ul"
            :animation="200"
          >
            <transition-group>
              <measure v-for="(item, index) in groupField" 
                :key="item.id"
                v-model="groupField[index]"
                :field="item.key && fieldMap[item.key]"
                @remove="onMeasureRemove(index)"
                ref="measure"
              />
            </transition-group>
          </draggable>
        </div>
      </div>
      <div class="body">
        <component v-if="queryData" 
          :is="chartType" 
          :settings="queryData.settings" 
          :dataTable="queryData.data" 
          ref="chart"
        />
        <div class="loading" v-if="loading">
          <a-spin size="large" tip="正在查询"/>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="header">
        <a-button type="primary" @click="save">保存</a-button>
        <a-button type="primary" @click="aggregate()">查询</a-button>
        <a-button type="primary" @click="doExport()" :disabled="!queryData">导出</a-button>
      </div>
      <div class="body">
        <a-collapse :bordered="false" style="background-color:unset;">
          <a-collapse-panel key="1" header="标题">
            <a-input :read-only="true" :value="chartData.settings.title" @click="editTitle({
              value: chartData.settings.title,
              placeholder: chartData.fields,
              callback: (value) => chartData.settings.title = value
            })" style="cursor: pointer;"/>
          </a-collapse-panel>
          <a-collapse-panel key="2" header="自定义数据" class="data-source">
            <DataSource v-model="chartData.fields"/>
          </a-collapse-panel>
        </a-collapse>
      </div>
    </div>
    <!-- 设置查询数据集合 -->
    <query-modal 
      :show="showQueryModal"
      :query="chartData.query"
      :namespace="namespace"
      :context="chartData.fields"
      :submit="false"
      @ok="onDataSetSelected"
      @cancel="() => showQueryModal = false"
    />
    <!-- 外部参数输入 -->
    <a-modal v-model="showInput"
      title="设置自定义数据"
      :width="500"
      :destroyOnClose="true"
      @ok="filedInputFinish"
      :bodyStyle="{paddingTop: '5px'}"
    >
      <PropValueForm :properties="chartData.fields" ref="propValueForm"/>
    </a-modal>
    <a-modal v-model="titleModel.show" title="标题" @ok="onTitleEdit">
      <a-input v-model="titleModel.value" ref="titleInput"/>
      <div style="margin-top: 10px" v-if="titleModel.placeholder">
        <tags :value="titleModel.placeholder" text="name" :deleteable="false" @click="onTagChecked"/>
      </div>
    </a-modal>
  </div>
</template>
<script>
import { Modal, Input, Button, Icon, Tooltip, Spin, Collapse} from 'ant-design-vue'
import Dimension from './components/Dimension'
import Measure from './components/Measure'
import QueryModal from '@person/views/integratedquery/QueryModal';
import DataSource from '../components/DataSource'
import PropValueForm from "@person/components/PropValueForm";
import Tags from '@framework/components/Tags'
import CustomIcon from '@framework/components/CustomIcon';
import { components } from "@person/components/chart";
import draggable from "vuedraggable";
import html2canvas from 'html2canvas'
import { aggregateQuery } from '@person/api/chart';
import { showError, randomStr } from '@framework/utils';


const TYPE_DICT = 2, TYPE_INPUT = 4, TYPE_INT = 1, TYPE_FLOAT = 2, TYPE_DATE = 3, TYPE_BOOL = 4;

export default {
	components:{
		AModal: Modal,
		AInput: Input,
		AButton: Button,
    AIcon: Icon,
    ATooltip: Tooltip,
    ASpin: Spin,
    ACollapse: Collapse,
    ACollapsePanel: Collapse.Panel,
    draggable,
    CustomIcon,
    QueryModal, Dimension, Measure,
    DataSource, PropValueForm, Tags,
    ...components,
  },
  props: {
    value: {//统计图对象
      type: Object,
      default: () => ({})
    },
    namespace: {//命名空间
      type: String,
      required: true,
    }
  },
	data(){
		return {
      showQueryModal: false,
      loading: false,
      chartData: {//统计配置
        title: undefined,
        query: undefined, //数据源
        groupby: {//分组表达式
          with: [],
          fields: [],
        },
        fields: undefined,
        settings: {//ui设置
          chartType: 'pie-chart',
          title: undefined,
        }
      },
      queryData: undefined,//统计结果数据表
      chartTypes: [
        { type: 'pie-chart', icon: 'pie-chart' },
        { type: 'bar-chart', icon: 'bar-chart' },
        { type: 'line-chart', icon: 'line-chart' },
      ],
      showInput: false,
      titleModel: {
        show: false,
        value: undefined,
        placeholder: undefined,
      }
		}
  },
  computed: {
    chartType: {
      set(value){
        this.$set(this.chartData.settings, 'chartType', value);
      },
      get(){
        return this.chartData.settings.chartType;
      }
    },
    fieldMap(){
      let map = {};
      if(this.chartData.query){
        this.chartData.query.fields.forEach(item => {
          map[item.key] = item;
        });
      }
      return map
    },
    dimension(){//根据数据源字段获取维度
      if(this.chartData.query){
        let arr = [{ showname: '指标名称', icon: 'table' }]
        this.chartData.query.fields.forEach(item => {
          let icon;
          if(item.datatype == TYPE_DICT){//字典
            icon = 'dict';
          }else if(item.datatype == TYPE_INPUT){//输入类型（排除字符串）
            if(TYPE_INT == item.inputtype){
              icon = 'int'
            }else if(TYPE_FLOAT == item.inputtype){
              icon = 'float'
            }else if(TYPE_DATE == item.inputtype){
              icon = 'date'
            }else if(TYPE_BOOL == item.inputtype){
              icon = 'bool'
            }
          }
          if(icon){
            arr.push({ ...item, icon });
          }
        });
        return arr;
      }
    },
    measure(){//根据数据源字段获取指标
      if(this.chartData.query){
        let arr = [{ showname: '记录数', icon: 'measure' }]
        this.chartData.query.fields.forEach(item => {
          let icon;
          if(item.datatype == TYPE_INPUT){//输入类型（排除字符串）
            if(TYPE_INT == item.inputtype){
              icon = 'int'
            }else if(TYPE_FLOAT == item.inputtype){
              icon = 'float'
            }
          }
          if(icon){
            arr.push({ ...item, icon });
          }
        });
        return arr;
      }
    },
    groupWith: {
      get(){
        let arr = this.chartData.groupby.with;
        if(arr){
          arr.forEach(item => this.generateId(item))
        }
        return arr;
      },
      set(value){
        this.chartData.groupby.with = value;
      }
    },
    groupField: {
      get(){
        let arr = this.chartData.groupby.fields;
        if(arr){
          arr.forEach(item => this.generateId(item))
        }
        return arr;
      },
      set(value){
        this.chartData.groupby.fields = value;
      }
    }
  },
  watch: {
    value(chart){
      if(this.chartData !== chart){
        this.initData(chart);
      }
    }
  },
  created(){
    this.initData(this.value);
  },
	methods: {
    initData(chart = {}){
      if(!chart.groupby){
        chart.groupby = { with: [], fields: [] }
      }
      if(chart.query){
        if(!chart.query.title){
          chart.query.title = '未命名';
        }
      }
      this.chartData = Object.assign({
        title: undefined,
        query: undefined,
        groupby: { with: [], fields: []},
        fields: undefined,
        settings: {//ui设置
          chartType: 'pie-chart',
          title: undefined,
        }
      }, chart);
    },
	  onDataSetSelected(query){
      this.chartData.query = query;
      if(this.chartData.query){//修改查询，看到已选的维度和指标是否任然存在
        let {'with': _with, fields} = this.chartData.groupby;
        this.chartData.groupby = { 
          with: (_with || []).filter(item => !item.key || this.fieldMap[item.key]), 
          fields: (fields || []).filter(item => !item.key || this.fieldMap[item.key]), 
        };
      }
      this.showQueryModal = false;
    },
    onDimensionClick(d){
      let type, withs = this.groupWith;
      if(!d.key){//key为空（指标名称）
         if(withs.find(item => item.type == 'field')){
          this.$message.error('指标名称已经添加');
          return;
        }
        type = 'field';
      }else{
        type = 'value';//字典按值统计
        if(d.datatype == TYPE_INPUT){
          if(d.inputtype == TYPE_DATE){//时间默认按日统计
            type = 'date'; //按值分组
          }else if(d.inputtype == TYPE_INT || d.inputtype == TYPE_FLOAT){//数字按区间
            type = 'section';
          }
        }
      }
      withs.push({
				type,
        key: d.key,
        showname: d.showname,
			});
    },
    onMeasureClick(i){
      let type, fields = this.groupField;
      if(!i.key){//key为空（记录数）
        if(fields.find(item => item.type == 'count')){
          this.$message.error('记录数已经添加');
          return;
        }
        type = 'count';
      }else if(!fields.find(item => item.key == i.key && item.type == 'sum')){
        type = 'sum';
      }else if(!fields.find(item => item.key == i.key && item.type == 'avg')){
        type = 'avg';
      }else{
        type = 'sum';
      }
      fields.push({ type, key: i.key, showname: i.showname })
    },
    onDimensionRemove(index){
      this.$delete(this.groupWith, index);
    },
    onMeasureRemove(index){
      this.$delete(this.groupField, index);
    },
    editTitle({value, placeholder, callback}){
      this.titleModel = { show: true, value, placeholder, callback }
      this.$nextTick(() => this.$refs.titleInput.focus())
    },
    onTitleEdit(){
      this.titleModel.show = false;
      this.titleModel.callback(this.titleModel.value);
    },
    onTagChecked(field){
      let dom = this.$refs.titleInput.$el;
      let start = dom.selectionStart, end = dom.selectionEnd;
      let text = this.titleModel.value || '';
      this.titleModel.value = text.substr(0, start) + '${' + field.code + '}' + text.substr(end);
      this.$nextTick(() => {
        dom.setSelectionRange(start, start + field.code.length + 3);
        dom.focus();
      })
    },
    validate(){
      if(!this.chartData.query){
				this.$message.error('未设置数据集');
				return;
      }
      let {'with': _with, fields} = this.chartData.groupby;
      if(!_with.length){//TODO 验证提示优化
        this.$message.error('未设置维度');
        return;
      }
      if(!fields.length){
        this.$message.error('未设置指标');
        return;
      }
      let unSetSection = _with.find(item => item.type == 'section' && !item.section);
      if(unSetSection){
        this.$message.error(unSetSection.showname + '未设置区间');
        return;
      }
      if(!this.chartType){
        this.$message.error('请选择图表类型');
        return;
      }
      return true;
    },
    save(){
      if(!this.validate()){
        return;
      }
      this.editTitle({
        value: this.chartData.title,
        callback: (value) => {
          this.chartData.title = value;
          this.chartData.namespace = this.namespace;
          this.$emit('input', this.chartData);
        }
      })
    },
    filedInputFinish(){
      this.$refs.propValueForm.getFieldsValue().then((context) => {
        this.showInput = false;
        this.aggregate(context);
      }).catch((error) => {
        this.$message.error(error);
      });
    },
    aggregate(context){
      if(!this.validate()){
        return;
      }
      if(this.chartData.fields && this.chartData.fields.length && !context){
        this.showInput = true;
        return;
      }
      this.loading = true;
      aggregateQuery({
        ...this.chartData,
        context,
      }).then(({result}) => {
        this.queryData = result
      }).catch((error) => {
        showError(error);
      }).finally(() => {
        this.loading = false;
      })
    },
    doExport(){
      let chart = this.$refs.chart;
      if(!chart){
        this.$message.info('未查询数据');
        return;
      }
      let name = this.queryData.settings.title || this.chartData.title || '未命名';
      html2canvas(chart.$el).then(canvas => {
        // let dataurl = canvas.toDataURL('image/png');//直接用base64部分浏览器不支持下载，图片过大导致url过长
        canvas.toBlob((blob) => {
          let a = document.createElement('a');
          a.style.display = 'none';
          a.setAttribute('href', URL.createObjectURL(blob));
          a.setAttribute('download', name + '.png');
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(blob);
          document.body.removeChild(a);
        }, 'image/png');
      });
    },
    generateId(item){
      if(!item.id){
        item.id = randomStr(6);
      }
      return item.id;
    },
	}
}
</script>
<style lang="less" scoped>
@axis-height: 42px;

.report-chart-panel{
	height: 100%;
	display: flex;
	background-color: @white;
	border-radius: @border-radius-base;
	& > .left{
    flex: 0 0 300px;
		height: 100%;
		display: flex;
		flex-direction: column;
		border-right: 1px dashed @border-color-base;
		padding: 10px;
		.title{
      margin-top: 10px;
      font-weight: bold;
      line-height: 1.8em;
		}
		.dimension{
			flex: 1 1 35%;
			margin: 0;
			overflow-y: auto;
		}
		.measure{
			flex: 1 1 35%;
			margin: 0;
			overflow-y: auto;
    }
    .dimension li,.measure li{
      line-height: 2em;
      cursor: pointer;
      text-indent: 5px;
      &:hover{
        background-color: @primary-1;
      }
      .icon{
        color: @primary-color;
        margin-right: 5px;
      }
    }
		.graph{
      flex: 1 1 30%;
      ul{
        margin: 0;
        li{
          float: left;
          width: 20%;
          height: 0;
          padding-top: 20%;
          position: relative;
          & > .item{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 6px;
          }
        }
      }
			.chart-type{
        border-radius: @border-radius-base;
				font-size: 30px;
        text-align: center;
        cursor: pointer;
        &.selected{
          background-color: @primary-1;
        }
        &:hover{
          color: @primary-color;
        }
			}
		}
	}
	& > .content{
    flex: 1 1 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    & > .header{
      flex: none;
      padding: @content-padding-v @content-padding-h;
      .axis{
        height: @axis-height;
        margin-top: 10px;
        padding-left: 50px;
        border-radius: @border-radius-base;
        background: @background-color-base;
        overflow: hidden;
        & > .title{
          position: absolute;
          width: 50px;
          margin-left: -50px;
          padding: 0 @padding-xs;
          line-height: @axis-height;
          border-right: 1px dashed @border-color-base;
          text-align: center;
        }
        & > ul{
          width: 100%;
          margin: 6px 0 0 0;
          padding: 0 @padding-xs;
          line-height: @axis-height - 12px;
          white-space: nowrap;
          overflow-x: auto;
        }
      }
    }
    & > .body{
      flex: auto;
      padding: @content-padding-v @content-padding-h;
      position: relative;
      .loading{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        .ant-spin{
          position: absolute;
          top: 30%;
          left: 50%;
          width: 100px;
          margin-left: -50px;
          padding: 12px 8px 8px 8px;
          text-align: center;
          background: fade(@background-color-base, 90%);
          box-shadow: 1px 1px 10px #dad9d9;
          border-radius: @border-radius-base;
        }
      }
    }
  }
  & > .right{
    flex: 0 0 225px;
    border-left: 1px dashed @border-color-base;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    & > .header{
      flex: none;
      padding: @content-padding-v 10px;
      text-align: center;
      .ant-btn{
        margin: 10px 8px 10px 0;
        padding-left: 12px;
        padding-right: 12px;
      }
      .ant-btn:last-child{
        margin-right: 0;
      }
    }
    & > .body{
      flex: auto;
      height: 100%;
      .data-source{
        /deep/ .ant-collapse-content > .ant-collapse-content-box{
          padding: 0;
        }
      }
    }
  }
}
</style>
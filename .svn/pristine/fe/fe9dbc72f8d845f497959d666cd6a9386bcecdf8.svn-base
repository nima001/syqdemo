<template>
  <div class="content">
    <div class="panel">
      <div class="toolbar">
        <a-form :form="form" class="ant-advanced-search-form">
          <div class="box">
            <ul class="in-box">
              <li class="li-content">
                <div>
                  <span class="name">文件类型：</span>
                  <a-select v-if="(this.$route.name==='regulations')||(this.$route.name==='important')" v-model="DocumentSubtype ? subtype : undefined"  @change="changetype" >
                    <a-select-option v-for="item in DocumentSubtype" :key="item.value" >
                      {{ item.text }}
                    </a-select-option>
                  </a-select>
                  <a-tree-select
                    v-else-if="this.$route.name==='organization'"
                    tree-default-expand-all
                    :getPopupContainer="triggerNode => triggerNode.parentNode"
                    :allowClear="true"
                    v-decorator="[ 'subtype' ]"
                    v-model="subtype"
                    :tree-data="DocumentSubtype"
                    @change="changetype"
                  />
                </div>
              </li>
              <li class="li-content">
                <div>
                  <span class="name">批准文号：</span>
                  <a-input-group compact class="pzwh">
                    <a-input type="text" v-model="pagination.zihao" style="width: 28%" />
                    <a-input
                      v-model="pagination.year"
                      addonBefore="〔"
                      addonAfter="〕"
                      type="text"
                      style="width: 40%; top: 0"
                    />
                    <a-input
                      v-model="pagination.ordinal"
                      addonAfter="号"
                      type="text"
                      style="width: 32%; top: 0"
                    />
                  </a-input-group>
                </div>
              </li>
              <li class="li-content">
                <div>
                  <span class="name">发文时间：</span>
                  <a-input-group compact style="top: 0">
                    <a-date-picker
                      placeholder="开始时间"
                      style="width: 50%"
                      v-model="startValue"
                      :disabled-date="disabledStartDate"
                    />
                    <a-date-picker
                      placeholder="结束时间"
                      style="width: 50%"
                      v-model="endValue"
                      :disabled-date="disabledEndDate"
                    />
                  </a-input-group>
                </div>
              </li>
              <li class="li-content">
                <div>
                  <span class="name">关键字:</span>
                  <div>
                    <a-input
                      v-model="pagination.searchkey"
                      placeholder="标题或文件内容"
                    />
                  </div>
                </div>
              </li>
              <li class="li-button">
                <div>
                  <span class="name"></span>
                  <div>
                    <a-button @click="search" type="primary" style="margin-right: 10px">搜索</a-button>
                    <a-button @click="onreset">重置</a-button>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <a-divider />
        </a-form>
      </div>
    </div>
    <div class="tablelist">
      <!-- <div style="margin-bottom: 16px">
        <a-button
          type="primary"
          :disabled="!hasSelected"
          :loading="loading"
          @click="start"
        >
          划转
        </a-button>
        <span style="margin-left: 8px">
          <template v-if="hasSelected">
            {{ `Selected ${selectedRowKeys.length} items` }}
          </template>
        </span>
      </div> -->
      <a-table
        :locale="{ filterConfirm: '确定' }"
        :scroll="{ y: 380 }"
        :loading="loading"
        :rowKey="(row)=>row.id"
        :pagination="false"
        :form="form"
        :data-source="tableData"
        :columns="columns"
      >
        <template slot="action" slot-scope="text,record"> 
          <span @click="downDoc(record)">下载</span>
          <span v-if="hasPermit('/person/document/edit')" @click="showModal(record)">修改</span>
          <span @click="showFile(record.id)">附件管理</span>
        </template>
      </a-table>
      <a-pagination
        showSizeChanger
        @change="onChange"
        :total="this.pagination.total"
        :current="this.pagination.pagenum"
        @showSizeChange="onShowSizeChange"
        :pageSize="this.pagination.pagesize"
        v-if="tableData.length&&!this.loading"  
        :showTotal="(total) => `总共：${total}条`"
      />
    </div>
    <edit-content
      :doctype="doctype"
      :visible.sync="visible"
      :record.sync="record"
      :orgidselected="orgidselected"
      @documentList="this.documentList"  
      :documentsubtype="documentsubtype" 
      :DocumentSubtype="DocumentSubtype" />
    <FileManage :docid="docid" :filemanageModal.sync="filemanageModal"/>
  </div>
</template>

<script>
import { Form, Input, DatePicker, Button, Select, Divider, Modal, Table, Pagination, Spin, TreeSelect } from "ant-design-vue";
import FileManage from '@framework/components/FileManage.vue';
import EditContent from "./EditContent";
import { includes, assign, difference, groupBy, values, reverse } from "lodash";
import { organization } from '@/person/api/org';
import { documentlist, documentbyid } from "@/person-shaoxing/api/information";
import { download } from "@/framework/api/file";
import { showError } from '@/framework/utils';
export default {
  props: {
    orgid: {//左侧单位id
      type: String,
    },
    type: {//用于判断显示机构编制或法律法规
      type: Number,
    }
  },
  components: {
    FileManage,
    AForm: Form,
    EditContent,
    ASpin: Spin,
    AInput: Input,
    AModal: Modal,
    ATable: Table,
    AButton: Button,
    ASelect: Select,
    ADivider: Divider,
    APagination: Pagination,
    ATreeSelect: TreeSelect,
    ADatePicker: DatePicker,
    AInputGroup: Input.Group,
    ASelectOption: Select.Option,
  },
  data() {
    return {
      spinning: false,
      record: {},
      visible: false,
      subtype: "all",
      startValue: null,
      endValue: null,
      orgidselected: undefined,
      // selectedRowKeys: [],
      loading: false,
      filemanageModal: false,
      docid: undefined,
      pagination: {
        total: 0,
        rows: [],
        pagenum: 1,
        pagesize: 10,
        statusIn:["1"],
        needtotal: true,
        type: undefined,
        year: undefined,
        orgid: undefined,
        zihao: undefined,
        ordinal: undefined,
        endtime: undefined,
        subtype: undefined,
        starttime: undefined,
        searchkey: undefined,
      },
      columns: [
        {
          title: "序号",
          dataIndex: "index",
          key: "index",
          width: '5%',
          customRender: (text, record, index) => `${index + 1}`,
        },
        {
          title: "文件标题",
          dataIndex: "title",
          key: "title",
        },
        {
          title: "批准文号",
          dataIndex: "num",
          key: "num",
          width: '20%',
        },
        {
          title: "文件来源",
          dataIndex: "source",
          key: "source",
          width: "10%",
          customRender: this.docsourceRender('library.docsource'),
        },
        {
          title: "发文时间",
          dataIndex: "dispatchdate",
          key: "dispatchdate",
          width: '15%',
        },
        {
          title: "操作",
          dataIndex: "action",
          key: "action",
          width: '20%',
          scopedSlots: { customRender: "action" },
        },
      ],
      form: this.$form.createForm(this, { name: "docform" }),
    };
  },
  computed: {
    doctype() {
      //发文类型 即文件归档
      return this.$store.getters.dict("library.doctype");
    },
    documentsubtype() {
      return this.$store.getters.dict("library.documentsubtype");
    },
    tableData: {
      set(val) {
        this.pagination.rows =val;
        return this.pagination.rows;
      },
      get() {
        return this.pagination.rows;
      }
    },
    // hasSelected() {
    //   return this.selectedRowKeys.length > 0;
    // },
    DocumentSubtype() {
      if(this.documentsubtype){
        let document = undefined;
        if(this.$route.name==='organization'){
          this.pagination.type = 1;
          document = this.documentsubtype.filter(item=>includes(item.group,"机构编制"));
          document = this.loadsubtype(document);
          if(document.length){
            document.unshift({title: "全部", value: 'all', key: 'all'});
          }
        }else if(this.$route.name==='regulations'){
          this.pagination.type = 3;
          document = this.documentsubtype.filter(item=>includes(item.group,"法律法规"));
          if(document.length){
            document.unshift({ group: "法律法规", text: "全部", value: "all" });
          }
        }else if(this.$route.name==='important') {
         this.pagination.type = 12;
          document = this.documentsubtype.filter(item=>includes(item.group,"重要业务"));
          document = reverse(document);
          if(document.length){
            document.unshift({ group: "重要业务", text: "全部", value: "all" });
          }
        }
        return document;
      }
    },
  },
  watch: {
    record(val) {
      return val;
    },
    type(val) {
      this.pagination.type = val;
      return val;
    },
    endValue(val) {
      this.pagination.endtime = val;
    },
    orgid: {
      immediate: true,
      handler(val) {
        if(val!=='41e21453acc24719bd3f9faaadfb5e68') {//绍兴市-不传orgid
          this.pagination.orgid = val;
        }else{
          this.pagination.orgid = undefined;
        }
        this.pagination.pagenum = 1;
        if(val){
          this.documentList();
        }
      }
    },
    startValue(val) {
      this.pagination.starttime = val;
    },
    subtype(val) {
      if(val!=='all'){
        this.pagination.subtype = val;
      }else{
        this.pagination.subtype = undefined;
      }
    },
  },
  methods: {
    docsourceRender(key) {
      return (text, row, index) => {
        let v = this.$store.getters.dictKey(key, text);
        text = (v && v.text) || "";
        return <span title={text}>{text}</span>;
      };
    },
    showFile(id) {
      this.docid = id;
      this.filemanageModal = true;
    },
    async showModal(value){
      await this.documentbyId(value.id);
    },
    // onSelectChange(selectedRowKeys) {
    //   console.log('selectedRowKeys changed: ', selectedRowKeys);
    //   this.selectedRowKeys = selectedRowKeys;
    // },
    loadsubtype(document) {
      let multilevelMenu = document.filter((item)=>item.group.split('/').length>1);//多级菜单
      let singlelevelMenu = difference(document,multilevelMenu);//单级菜单
      let menus = [];
      multilevelMenu = groupBy(multilevelMenu,'group');
      if(multilevelMenu.length===1) {
        values(multilevelMenu)[0].forEach((item,index)=>{
          if(index===0){
            menus.push({title: item.group.split('/')[1], selectable: false, key: `${item.value}${index}`, value: `${item.value}${index}`, children: []});
          }
          menus[0].children.push({ title: item.text , value: item.value,  key: item.value });
        });
      }else{
        values(multilevelMenu).forEach((item,index)=>{  
          item.forEach((childItem,childIndex)=>{
            if(childIndex===0){
              menus.push({title: childItem.group.split('/')[1], selectable: false, key: `${childItem.value}${index}`, value: `${childItem.value}${index}`, children: []});
            }
            menus[index].children.push({ title: childItem.text , value: childItem.value,  key: childItem.value });
          })
        });
      }
      singlelevelMenu.forEach((item,index)=>{
        menus.push({title: item.text, value: item.value, key: index});
      });
      return menus;
    },
    disabledStartDate(startValue) {
      const endValue = this.endValue;
      if (!startValue || !endValue) {
        return false;
      }
      return startValue.valueOf() > endValue.valueOf();
    },
    changetype(val) {
      this.subtype = val;
    },
    disabledEndDate(endValue) {
      const startValue = this.startValue;
      if (!endValue || !startValue) {
        return false;
      }
      return startValue.valueOf() >= endValue.valueOf();
    },
    onreset() {
      this.subtype = "all";
      this.pagination.ordinal = undefined;
      this.pagination.year = undefined;
      this.pagination.zihao = undefined;
      this.pagination.starttime = undefined;
      this.pagination.endtime = undefined;
      this.pagination.searchkey = undefined;
      this.startValue = null;
      this.endValue = null;
    },
    search() {
      if (this.pagination.rows) {
        this.pagination.rows = [];
      }
      this.pagination.pagenum = 1;
      this.documentList();
    },
    //翻页
    onChange(pagenum, pagesize) {
      assign(this.pagination, { pagesize, pagenum });
      this.documentList();
    },
    //pagesize改变回调
    onShowSizeChange(current, pagesize) {
      assign(this.pagination, { pagesize, pagenum: 1 });
      this.documentList();
    },
    downDoc(record) {
      if (record.fileuri) {
        download(record.fileuri);
      } else {
        this.$notification.warning({
          message: "提示",
          description: "暂无可下载内容!",
          duration: 3,
        });
      }
    },
    documentbyId(id) {
      this.loading = true;
      documentbyid(id).then((res)=>{
        this.record = res.result;
        if(this.record.orgid) {
          this.organization(this.record.orgid);
        }else{
          this.loading = false;
          this.visible = true;
        }
      }).catch((err) => {
        this.loading = false;
        showError(err);
      });
    }, 
    organization(id) {
      organization(id).then((res)=>{ 
        this.loading = false; 
        this.orgidselected={ orgname:res.result.name,orgid: this.record.orgid };
        this.visible = true;
      }).catch((err)=>{
        this.loading = false;
        showError(err);
      })
    },
    documentList() {
      this.loading = true;
      if(this.pagination.rows.length){
        this.pagination.rows = [];
      }
      documentlist(this.pagination).then((res)=>{
        this.loading = false;
        if (res.result.rows.length) {
            assign(this.pagination, res.result);
          } else {
            this.pagination.rows = [];
            this.$notification.warning({
              message: "提示",
              description: "暂无数据!",
              duration: 3,
            });
          }
        }).catch((err)=>{
          this.loading = false;
          showError(err);
        })
    },
  },
};
</script>
<style scoped lang="less">
.content {
  //新增 content样式修改（height，padding，background）
  height: 100%;
  padding: 10px 24px;
  background: #ffffff;
  position: relative;
  .ant-spin {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    z-index: 999;
  }
  .toolbar {
    width: 100%;
    margin: 0 auto;
    .ant-advanced-search-form {
      .in-box {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 0;
      }
      .li-content:not(:last-child) {
        width: 20%;
        min-width: 250px;
      }
      .li-content:nth-child(3),.li-content:nth-child(2),.li-content:nth-child(1) {
        flex: 1;
      }
      /deep/.li-content {
        padding: @layout-space-base;
        padding-left: 0;
        & .pzwh {
          top: 0;
          display: inline-block;
          vertical-align: middle;
        }
        & .pzwh .ant-input {
          border: none;
          height: 30px;
        }
        & span.pzwh.ant-input-group {
          border: 1px solid #d9d9d9;
          border-radius: 4px;
        }
        & span.ant-input-group-addon {
          border: none;
          background: none;
          padding: 0 4px;
        }
      }
      .li-button {
        padding: @layout-space-base;
        padding-left: 0;
      }
      .name {
        line-height: 32px;
        padding-right: 5px;
      }
    }
  }
  .tablelist {
    /deep/.ant-table-fixed-header .ant-table-scroll .ant-table-header {
      margin-bottom: 0;
      padding-bottom: 0;
      overflow-y: visible;
    }
    /deep/.ant-table-body {
      overflow-y: auto !important;
    }
    margin-top: 10px;
    & ul.ant-pagination {
      float: right;
      margin-top: 10px;
    }
    /deep/.ant-table-tbody {
      & > tr > td {
        max-width: 160px;
        overflow: hidden;
        word-break: keep-all;
        white-space: nowrap;
        text-overflow: ellipsis;
      }
      & tr td:last-child span {
        margin-right: 8px;
        cursor: pointer;
        color: @primary-color;
      }
    }
  }
}
</style>

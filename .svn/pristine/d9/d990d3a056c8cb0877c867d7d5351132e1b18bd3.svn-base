<template>
  <dialog-box 
    v-model="show"
    :title="(districtName || '') + title"
  >
    <div class="detail-info">
      <div class="header">
        <ul>
          <li>
            <div class="name">{{title}}</div>
            <lcd-font :length="4" :realNumber="num" :realStyle="{color: '#7dc8a3'}"/>
            <div class="tooltip">
              <div class="arrow"></div>
              <div class="content">{{typeName}}机构个数 {{orgcount}}</div>
            </div>
          </li>
          <li class="operater">=</li>
          <li>
            <div class="name">核定数</div>
            <lcd-font :length="4" :realNumber="total"/>
          </li>
          <li class="operater">-</li>
          <li>
            <div class="name">实有数</div>
            <lcd-font :length="4" :realNumber="used"/>
          </li>
        </ul>
      </div>
      <div class="body">
        <ul class="bar-chart">
          <li v-for="item in list" :key="item.k0">
            <div class="num">{{Math.max(item.v0 || 0, 0)}}</div>
            <div class="bar" @click="showOrgList(item)">
              <div :style="{
                height: getBarPercent(item.v0)
              }"></div>
            </div>
            <div class="label">{{item.k0}}</div>
          </li>
        </ul>
      </div>
    </div>
    <org-list v-model="orgList.show" :title="orgList.title" :params="orgList.params"/>
  </dialog-box>
</template>
<script>
import DialogBox from '../components/DialogBox'
import LcdFont from "../components/LcdFont";
import OrgList from '../components/OrgList'
import { mixins } from "../components/minxin";
import { orgCountKong, systypeReport } from "@/person-shaoxing/api/orgStaffReport";
import { showError } from "@/framework/utils/index";

export default {
  components: {
    DialogBox, LcdFont, OrgList
  },
  mixins: [mixins],
  props: {
    value: Boolean,
    title: String,
    total: {
      type: Number,
      default: 0
    },
    used: {
      type: Number,
      default: 0
    },
    xz: Boolean,
    type: String,
  },
  data(){
    return {
      show: this.value,
      orgcount: 0,
      list: [],
      orgList: {
        show: false,
        title: '',
        params: {}
      }
    }
  },
  computed: {
    typeName(){
      return `空${this.type == 'ld' || this.type == 'zcld' ? '职' : '编'}`
    },
    num(){
      if(this.total >= 0 && this.used >= 0){
        return this.total - this.used;
      }
      return 0;
    },
    maxNum(){
      let num = 0;
      this.list.forEach((item) => {
        if(item.v0 > 0 && num < item.v0){
          num = item.v0;
        }
      });
      return num
    },
    params(){
      return {
        district: this.dictId,
        xz: this.xz,
        type: this.type,
      }
    }
  },
  watch: {
    value(value){
      this.show = value;
    },
    show(show){
      this.$emit('input', show);
    },
    params:{
      immediate: true,
      handler(p){
        this.loadDetail(p);
      }
    }
  },
  methods: {
    showOrgList(item){
      this.orgList = {
        show: true,
        title: `${this.typeName}机构列表（${item.k0}）`,
        params: Object.assign({
          cktype: 1,
          systype: item.k0
        }, this.params)
      }
    },
    getBarPercent(num){
      if(this.maxNum > 0){
        num = Math.max(num || 0, 0);
        return `${100 - (num * 100/this.maxNum).toFixed(2)}%`
      }
      return "100%"
    },
    loadDetail({district, xz, type}){
      orgCountKong(district, xz, type).then(({result}) => {
        this.orgcount = result;
      }).catch((error) => {
        showError(error);
      });
      systypeReport(district, xz, type).then(({result}) => {
        this.list = result.rows;
      })
    }
  }
}
</script>
<style lang="less" scoped>
.detail-info{
  height: 600px;
  overflow: hidden;
  & > .header{
    text-align: center;
    margin-top: 90px;
    height: 170px;
    ul{
      overflow: hidden;
      .operater{
        padding: 0 20px;
        color: #8fc7ff;
        line-height: 56px;
        vertical-align: bottom;
        font-size: 30px;
        font-weight: bold;
      }
      li{
        display: inline-block;
        .name{
          color: white;
          text-align: center;
          line-height: 1.6em;
          font-size: 16px;
        }
      }
      .tooltip{
        position: absolute;
        margin-left: -36px;
        & > .arrow{
          width: 0;
          border-left: 8px solid;
          border-right: 8px solid;
          border-bottom: 5px solid #151920;
          margin: auto;
        }
        & > .content{
          padding: 15px 20px 15px 50px;
          color: white;
          background-color: #151920;
          background-image: url("../img/jigou.png");
          background-repeat: no-repeat;
          background-position: 15px 15px;
          border-radius: 5px;
          font-size: 16px;
        }
      }
    }
  }
  & > .body{
    .bar-chart{
      display: flex;
      justify-content: center;
      li{
        width: 74px;
        padding: 4px;
        text-align: center;
        .num{
          color: #7dc8a3;
          font-size: 18px;
          font-weight: bold;
        }
        .bar{
          width: 16px;
          height: 160px;
          background: linear-gradient(to top, #96f44e, #57f5e6 66%, #7dc8a3);
          margin: auto;
          position: relative;
          cursor: pointer;
          & > div{
            background-color: #343434;
          }
        }
        .label{
          color: white;
          font-size: 16px;
        }
      }
    }
  }
}
</style>
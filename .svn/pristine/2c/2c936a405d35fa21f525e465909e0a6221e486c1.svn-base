<template>
<div>
  <h2 v-if="settings&&settings.title" :style="{textAlign:'center'}">{{settings.title}}</h2>
  <div style="height: 100%" ref="pieChart"></div>
</div>
</template>
<script>
import { Pie } from '@antv/g2plot';

export default {
  props: {
    dataTable: {//数据表(dimension:维度列 measure:指标列 rows:数据列)
      type: Object
    },
    settings: {
      type: Object
    }
  },
  data(){
    return {
      plot: undefined,
      color:["#D15456","#5488D1","#EDBA55","#D48265","#91C7AE","#749F83","#BDA29A","#6E7074","#585470","#706254"]
    }
  },
  watch: {
    dataTable(dataTable){
      this.updateData(dataTable);
    }
  },
  mounted(){
    this.updateData(this.dataTable);
  },
  methods: {
    createData(dataTable){
      if(!dataTable){
        return;
      }
      let { keyCols, valueCols, rows } = dataTable;
      // if(dimension.)//按指标名称（列分布）
      return rows.map(item => {
        let keys = keyCols.map(k => item[k.column]);
        return {
          key: keys.join('-'),
          value: item[valueCols[0].column] || 0 //饼图指标暂时只能显示一个数据
        }
      })
    },
    updateData(dataTable){
      let data = this.createData(dataTable);
      if(!data){
        return;
      }
      if(this.plot){
        this.plot.destroy();
      }
      this.plot = new Pie(this.$refs.pieChart, {
        forceFit: true,
        radius: 0.8,
        data,
        angleField: 'value',
        colorField: 'key',
        color:this.color,
        label: {
          visible: true,
          type: 'outer-center',
          formatter: (text, item) => `${item._origin.key} ${item._origin.value}`,
        },
      });
      this.plot.render();
    }
  }
}
</script>
<template>
  <div>
    <Title title="编制资源分析"/>
    <div class="container" style="height:545px">
      <SwiperChart :size="200">
        <div slot="content">
          <div class="swiper-content">
            <div class="detail xz">
              <div class="title">党政群待分配数</div>
              <div class="num" @click="showModal('党政群待分配数',data.dzqbzdfps,data.dzqbzsdjs,data.dzqbzsjfps)">{{data.dzqbzdfps||0}}</div>
              <div class="total">省核定基数<span>{{data.dzqbzsdjs||0}}</span></div>
              <div class="total">实际分配数<span>{{data.dzqbzsjfps||0}}</span></div>
            </div>
            <div class="detail xz">
              <div class="title">党政群空编数</div>
              <div class="num" @click="showModal('党政群空编数',data.dzqbzkbs,data.dzqbzsdjs,data.dzqbzsyrs)">{{data.dzqbzkbs||0}}</div>
              <div class="total">省核定基数<span>{{data.dzqbzsdjs||0}}</span></div>
              <div class="total">实有人数<span>{{data.dzqbzsyrs||0}}</span></div>
            </div>
            <div class="detail xz">
              <div class="title">政法待分配数</div>
              <div class="num" @click="showModal('政法待分配数',data.zfzxbzdfps,data.zfzxbzsdjs,data.zfzxbzsjfps)">{{data.zfzxbzdfps||0}}</div>
              <div class="total">省核定基数<span>{{data.zfzxbzsdjs||0}}</span></div>
              <div class="total">实际分配数<span>{{data.zfzxbzsjfps||0}}</span></div>
            </div>
            <div class="detail xz">
              <div class="title">政法空编数</div>
              <div class="num" @click="showModal('政法空编数',data.zfzxbzkbs,data.zfzxbzsdjs,data.zfzxbzsyrs)">{{data.zfzxbzkbs||0}}</div>
              <div class="total">省核定基数<span>{{data.zfzxbzsdjs||0}}</span></div>
              <div class="total">实有人数<span>{{data.zfzxbzsyrs||0}}</span></div>
            </div>
          </div>
          <div class="chart-detail">
            <RingChart
              v-if="dataXz"
              :data="dataXz"
              :settings="{
                title: '党政群行政编制分布情况',
                padding: [-10,0,0,-40],
                canvas: { width: 400, height: 180 },
                color: ['#F2A54D','#60B4F5','#F84848','#DF6EA3','#6EDF75','#A66DF5','#C3F1CE','#A0A4F5'],
                legend: {
                  visible: true,
                  position: 'right',
                  flipPage: false,
                  offsetX: -80,
                  offsetY: 0,
                  marker: 'square',
                },
                radius: 0.8,
                innerRadius: 0.8,
                infoText: {
                  title: dataXz.rows[0].k0,
                  offsetY: -10,
                  style: { fontSize: 11, fill: '#fff', textAlign: 'center' },
                },
                contentStyle: {
                  offsetY: 10,
                  fontSize: 20, fill: '#fff', textAlign: 'center'
                }
              }"
            />
          </div>
          <div class="bottom-total">
            <div class="total-user xz">
              <img src="../../../assets/img/screen/xz-icon-user.png">
              编外人员数
            </div>
            <div class="total-num">
              <LcdFont :length="7" :realNumber="data.bwrysysxz" :realStyle="xzRealStyle" :fakeStyle="fakeStyle"/>
            </div>
          </div>
        </div>
        <div slot="content">
          <div class="swiper-content">
            <div class="detail sy">
              <div class="title">事业待分配数</div>
              <div class="num" @click="()=>showModal('事业待分配数',data.sybzdfps,data.sybzsdjs,data.sybzsjfps)">{{data.sybzdfps||0}}</div>
              <div class="total">省核定基数<span>{{data.sybzsdjs||0}}</span></div>
              <div class="total">实际分配数<span>{{data.sybzsjfps||0}}</span></div>
            </div>
            <div class="detail sy">
              <div class="title">事业空编数</div>
              <div class="num" @click="()=>showModal('事业空编数',data.sybzkbs,data.sybzsdjs,data.sybzsyrs)">{{data.sybzkbs||0}}</div>
              <div class="total">省核定基数<span>{{data.sybzsdjs||0}}</span></div>
              <div class="total">实有人数<span>{{data.sybzsyrs||0}}</span></div>
            </div>
            <div class="detail sy">
              <div class="title">报备员额空额数</div>
              <div class="num" @click="()=>showModal('报备员额空额数',data.bbyekes,data.bbyehds,data.bbyesyrs)">{{data.bbyekes||0}}</div>
              <div class="total">核定员额数<span>{{data.bbyehds||0}}</span></div>
              <div class="total">实际分配数<span>{{data.bbyesyrs||0}}</span></div>
            </div>
          </div>
          <div class="chart-detail">
            <RingChart
              v-if="dataSy"
              :data="dataSy"
              :settings="{
                title: '事业编制(报备员额)分布情况',
                padding: [-10,0,0,-40],
                canvas: { width: 400, height: 180 },
                color: ['#F2A54D','#60B4F5','#F84848','#DF6EA3','#6EDF75','#A66DF5','#C3F1CE','#A0A4F5'],
                legend: {
                  visible: true,
                  position: 'right',
                  flipPage: false,
                  offsetX: -80,
                  offsetY: 0,
                  marker: 'square',
                },
                radius: 0.8,
                innerRadius: 0.8,
                infoText: {
                  title: dataSy.rows[0].k0,
                  offsetY: -10,
                  style: { fontSize: 11, fill: '#fff', textAlign: 'center' },
                },
                contentStyle: {
                  offsetY: 10,
                  fontSize: 20, fill: '#fff', textAlign: 'center'
                }
              }"
            />
          </div>
          <div class="bottom-total">
            <div class="total-user sy">
              <img src="../../../assets/img/screen/sy-icon-user.png">
              编外人员数
            </div>
            <div class="total-num">
              <LcdFont :length="7" :realNumber="data.bwrysyssy" :realStyle="syRealStyle" :fakeStyle="fakeStyle"/>
            </div>
          </div>
        </div>
      </SwiperChart>
    </div>
    <AnalyzeDetail v-model="show" :title="title" :data="dataSource" :kbNum="kbNum" :numDesc="numDesc" :total="total" :used="used"/>
  </div>
</template>

<script>
import Title from './Title'
import SwiperChart from './SwiperChart'
import RingChart from "@person/components/chart/RingChart";
import LcdFont from './LcdFont';
import AnalyzeDetail from './AnalyzeDetail';
import { reduce, isNumber } from 'lodash';
import { areaStatistics } from '@/person-shaoxing/api/orgStaffReport'
import { staffAnalyzeSy, staffAnalyzeXz } from '../../../api/analyze';
import { showError } from '../../../../framework/utils';

export default {
  props: {
    districtCode: {
      type: String
    }
  },
  components: {
    Title,
    SwiperChart,
    RingChart,
    LcdFont,
    AnalyzeDetail
  },
  data(){
    return {
      dataXz: undefined,
      dataSy: undefined,
      dataSource: undefined,
      data: {},
      title: '',
      kbNum: 0,
      numDesc: 0,
      total: 0,
      used: 0,
      show: false,
      xzRealStyle: {
        color: "#01E3FC",
        textStroke: "1 #ECA066",
        opacity: 0.95,
        fontSize: '1.8em',
      },
      syRealStyle: {
        color: "#FF7C28",
        textStroke: "1 #ECA066",
        opacity: 0.95,
        fontSize: '1.8em',
      },
      fakeStyle: {
        fontSize: '1.8em',
      }
    }
  },
  watch: {
    districtCode(val) {
      this.getStaffData(val);
      this.loadData(val);
      return val;
    }
  },
  mounted() {
    if(this.districtCode) {
      this.getStaffData(this.districtCode);
      this.loadData(this.districtCode);
    }
  },
  methods: {
    showModal(title,kbNum,total,used) {
      this.title = title;
      this.kbNum = kbNum||0;
      this.total = total||0;
      this.used = used||0;
      areaStatistics(this.districtCode,[
        'dzqjgsdjsqsgdw', 'dzqjgsdjshsgdw',
        'dwxlkbsyjgs', 'rdxlkbxzsys',
        'zfxlkbsyjgs', 'zxxlkbsyjgs',
        'mzdpkbxlsyjgs', 'qzttkbxlsyjgs',
        'fykbxlsyjgs', 'jcykbxlsyjgs',
        'qtkbxsyljgs'
      ]).then(({result}) => {
        this.numDesc =  reduce(result,(sum,n)=>{
          if(!isNumber(sum)) {
            sum = 0;
          }
          if(!isNumber(n)) {
            n=0;
          }
          return parseInt(sum)+parseInt(n);
        });
        this.dataSource = result;
        this.show = true;
      }).catch(error => {
        showError(error)
      });
    },
    loadData(val) {
      staffAnalyzeXz(val).then(({result})=>{
        this.dataXz = result;
      }).catch(error=>{
        showError(error);
      })
      staffAnalyzeSy(val).then(({result})=>{
        this.dataSy = result;
      }).catch(error=>{
        showError(error);
      })
    },
    getStaffData(district){
      areaStatistics(district, [
        'dzqbzdfps', 'dzqbzkbs',
        'zfzxbzdfps', 'zfzxbzkbs',
        'dzqbzsdjs', 'dzqbzsjfps',
        'zfzxbzsdjs', 'zfzxbzsjfps',
        'dzqbzsyrs', 'zfzxbzsyrs',
        'sybzdfps', 'sybzkbs',
        'bbyekes', 'sybzsyrs',
        'sybzsjfps', 'bbyehds',
        'bbyesyrs', 'sybzsdjs',
        'bwrysysxz', 'bwrysyssy'
      ]).then(({result}) => {
        this.data = result;
      }).catch(error => {
        showError(error)
      });
    },
  }
}
</script>

<style scoped lang='less'>
@font-face {
  font-family: LESLIEB;
  src: url("../../../assets/img/screen/LESLIEB_.TTF") format("truetype");
}
.container {
  /deep/.ant-carousel {
    display: flex;
    justify-content: center;
    .slick-slider {
      width: 95%;
      padding: 0 @layout-space-base;
      .slick-slide {
        padding: @layout-space-base 0;
        background: fade(#000, 30%);
      }
    }
  }
  /deep/.swiper-content {
    display: flex;
    flex-wrap: wrap;
    .detail {
      width: 48%;
      margin-bottom: @layout-space-base;
      margin-left: 5px;
      &.xz:nth-child(2n-1) .title {
        background: url('../../../assets/img/screen/xz-head-top-left.png') no-repeat;
        background-size: 100% 100%;
      }
      &.xz:nth-child(2n) .title {
        background: url('../../../assets/img/screen/xz-head-top-right.png') no-repeat;
        background-size: 100% 100%;
      }
      &.sy:nth-child(2n-1) .title {
        background: url('../../../assets/img/screen/sy-head-top-left.png') no-repeat;
        background-size: 100% 100%;
      }
      &.sy:nth-child(2n) .title {
        background: url('../../../assets/img/screen/sy-head-top-right.png') no-repeat;
        background-size: 100% 100%;
      }
      .title {
        margin: 0;
        padding: @padding-xs/2 36px;
        font-size: 1em;
        color: #fff;
      }
      .num {
        font-family: LESLIEB;
        padding: 0 @padding-lg;
        text-align: center;
        font-size: 1.3em;
        font-weight: 500;
        cursor: pointer;
      }
      &.xz .num {
        color: #01E3FC;
      }
      &.sy .num {
        color: #FF7C28;
      }
      .total {
        padding: 0 @padding-lg 0 @padding-lg;
        font-size: 0.8em;
        color: fade(#fff, 80%);
        span {
          float: right;
        }
      }
    }
  }
  .chart-detail {
    padding-top: @padding-sm;
    background: url('../../../assets/img/screen/icon-division.png') no-repeat;
    .ring-chart {
      height: auto;
      // background: url('../../../assets/img/screen/pie-bg.png') no-repeat;
      background-size: 39%;
      background-position: 22.5% 98%;
    }
    /deep/.ring-chart {
      h2 {
        font-size: 1em;
        color: #fff;
      }
      & .chart canvas {
        position: relative;
        ::before {
          content: '';
          position: absolute;
          top: 0%;
          bottom: 0;
          left: 0;
          right: 0;
          background: #000;
        }
      }
    }
  }
  .bottom-total {
    padding-top: @padding-md;
    background: url('../../../assets/img/screen/icon-division.png') no-repeat;
    display: flex;
    align-items: center;
    justify-content: space-between;
    .total-user {
      width: 60%;
      padding: @padding-xs;
      color: #fff;
      font-size: 1.1em;
      &.xz {
        background: url('../../../assets/img/screen/xz-icon-user-background.png') no-repeat;
        background-size: 100%;
      }
      &.sy {
        background: url('../../../assets/img/screen/sy-icon-user-background.png') no-repeat;
        background-size: 100%;
      }
      img {
        margin-right: @layout-space-base;
        display: inline-block;
      }
    }
    .total-num {
      margin-right: @layout-space-base;
    }
  }
}
</style>
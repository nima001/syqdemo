<template>
  <a-modal :visible="value" :title="record.id ? '编辑字段' : '新增字段'" :width="800" :bodyStyle="{ overflow: 'auto', height: '550px', padding: '8px 24px' }"
    destroyOnClose @ok="ok" @cancel="cancel"
  >
  <a-form :form="form">
    <a-row :gutter="20">
      <a-col :span="12">
        <a-form-item label="统计模型">
          <a-select :disabled="!!record.id" @change="form.setFieldsValue({expression: undefined})"
            v-decorator="['model', { initialValue: getModelVal(record.model), rules: [{ required: true, message: '请选择统计模型' }]}]">
            <a-select-option v-for="item in modelList" :key="item.name">{{item.name}}</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>
      <a-col :span="12">
        <a-form-item label="字段编码">
          <a-input :disabled="!!record.id"
            v-decorator="['code',{
              initialValue: record.code, 
              rules: [{ required: true, message: '请输入字段编码' }, { pattern: /^[a-zA-Z][0-9a-zA-Z_]*$/, message: '字段编码由数字、字母、下划线组成，且是字母开头' }] 
            }]"
          />
        </a-form-item>
      </a-col>
    </a-row>
    <a-row :gutter="20">
      <a-col :span="12">
        <a-form-item label="字段名称">
          <a-input v-decorator="['name', { initialValue: record.name, rules: [{ required: true, message: '请输入字段名称' },]}]"/>
        </a-form-item>
      </a-col>
      <a-col :span="12">
        <a-form-item label="字段分类">
          <a-input v-decorator="['sort', { initialValue: record.sort, rules: [ { required: true, message: '请输入字段分类' },]}]"/>
        </a-form-item>
      </a-col>
    </a-row>
    <a-row :gutter="20">
      <a-col :span="12">
        <a-form-item label="输入类型" :required="true">
          <a-select v-decorator="['inputtype', { initialValue: record.inputtype, rules: [{ required: true, message: '请选择输入类型' }]}]">
            <a-select-option :value="0">字符串</a-select-option>
            <a-select-option :value="1">整数</a-select-option>
            <a-select-option :value="2">浮点数</a-select-option>
            <a-select-option :value="3">时间</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>
      <a-col :span="12">
        <a-form-item label="字段排序">
            <a-input v-decorator="['index', { initialValue: record.index, rules: [ { pattern: /^[1-9]\d*$/, message: '请输入数字' }]}]"/>
          </a-form-item>
      </a-col>
    </a-row>
  </a-form>
</a-modal>
</template>
<script>
import { Modal, Row, Col, Select, Input, Form, Switch, InputNumber } from "ant-design-vue";
import { newfield, editupd } from "@/person/api/field";
import { showError } from "@/framework/utils/index";

export default {
  name: "StatisticsChange",
  components: {
    ARow: Row,
    ACol: Col,
    ASelect: Select,
    ASelectOption: Select.Option,
    AInput: Input,
    AInputNumber: InputNumber,
    AForm: Form,
    AFormItem: Form.Item,
    ASwitch: Switch,
    ATextarea: Input.TextArea,
    AModal: Modal,
  },
  props: {
    value: {
      type: Boolean,
      default: false,
    },
    record: {
      type: Object,
      default: () => ({})
    },
    targetlist: {
      type: Array,
      default: () => ([])
    },
    modelList: {
      type: Array,
      default: () => ([])
    },
  },
  data() {
    return {
      form: this.$form.createForm(this, { name: "dynamic_rule" }),
      datasets: [],
      expr: {
        show: false,
        params: {},
        data: ""
      },
    };
  },
  watch: {
    record(v){
      this.initData();
    }
  },
  created() {
    this.initData();
  },
  methods: {
    getModelVal(model){
      if(model == "organization"){
        return "组织"
      }else if(model == "user"){
        return "用户"
      }
    },
    getModelStr(value){
      if(value == "组织"){
        return "organization"
      }else if(value == "用户"){
        return "user"
      }
    },
    initData(){
      this.datasets = this.record.datasets || [];
    },
    cancel() {
      this.$emit("input", false);
    },
    ok() {
      this.form.validateFields((err, values) => {
        let model = this.getModelStr(values.model)
        if (!err) {
          let obj = {
            id: this.record.id,
            targetid: values.targetid,
            model:model,
            code: values.code,
            enable: values.enable,
            name: values.name,
            index: values.index,
            sort: values.sort,
            inputtype: values.inputtype,
            type: values.type,
            expression: values.expression,
            datasets: this.datasets
          };
          if (!this.record.id) {
            newfield(obj).then(({result}) => {
              obj.id = result;
              this.$message.success("新增成功");
              this.$emit("finish", obj);
            }).catch(err => {
              showError(err);
            });
          } else {
            editupd(obj).then(res => {
              this.$message.success("编辑成功");
              this.$emit("finish", obj);
            }).catch(err => {
              showError(err);
            });
          }
        }
      });
    },
    openbox() {
      let targetid = this.form.getFieldValue('targetid');
      if(!targetid){
        this.$message.info("请先选择统计对象");
        return
      }
      let t = this.targetlist.find(item => item.id == targetid);
      this.expr.params = {target: t.namespace};
      this.expr.data = this.record.expression;
      this.expr.show = true;
    },
    finish(type, expr) {
      if (type == "ok") {
        this.form.setFieldsValue({
          expression: expr
        });
        this.expr.show = false;
      } else {
        this.expr.show = false;
      }
    }
  }
};
</script>
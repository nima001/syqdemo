import { getCookie } from './utils/auth'
import {removeStart} from './utils/index'
import 'nprogress/nprogress.css'
import NProgress from 'nprogress'
import store from './store'

NProgress.configure({ easing: 'ease', speed: 500, showSpinner: false });
export default function accessFilter(router){
  router.beforeEach(function(to, from, next){
    NProgress.start()
    let fromModule = removeStart(from.path, '/').split('/')[0];
    let toModule = removeStart(to.path, '/').split('/')[0];
    // if( process.env.NODE_ENV == 'development'){
    //   console.log(from, to)
    // }
    if(fromModule && toModule && fromModule != toModule){//不是同一个模块 跳转到目标模块
      window.location.href = router.resolve(to).href;
    }else { // 鉴权
      let auth = to.meta && to.meta.auth;
      if(auth != 'login' && auth != 'auth'){
        next()
        NProgress.done()
      }else if (!getCookie('X-Commnet-Token')){
        //未登录 跳转登录页
        if(fromModule == 'login'){
          next({ path: '/login', query: { redirect: to.fullPath }, replace: true })
          NProgress.done()
        }else{
          let url = router.resolve('/login').href;
          window.location.replace(url + '?redirect=' + encodeURIComponent(to.fullPath));
        }
      }else if(auth == 'login'){
        //页面权限为登录
        next()
        NProgress.done()
      }else{
        store.getters.asyncPermit(to.matched.slice(-1)[0].path, 1).then((hasPermit) => {
          if(hasPermit){ //验证授权通过
            next()
          }else{
            next({ path: '/error/404' })//FIXME 跳转403
          }
        }).catch(error => {
          next({ path: '/error/404' })//FIXME 提示错误
        }).finally(() => {
          NProgress.done()
        })
      }
    }
  });
}
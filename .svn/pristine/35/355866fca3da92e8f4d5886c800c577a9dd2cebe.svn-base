<template>
  <div class="functional-design">
    <div
      class="functional"
      ref="functionalBody"
      :class="orgdata ? '' : 'flexbox'"
    >
      <!--相关机构-->
      <div class="functional-content">
        <div
          class="content-header"
          id="header-top"
          :class="orgdata ? '' : 'contentbox'"
        >
          <div class="header-left">
            <a-input
              style="width: 200px; margin-right: 15px"
              :value="orgValue"
              placeholder="请选择机构"
            >
              <a-icon
                slot="addonAfter"
                type="select"
                class="left-icon"
                @click="orgModelShow"
              />
            </a-input>
            <a-input
              placeholder="请输入关键字"
              style="width: 400px; margin-right: 15px"
              allow-clear
              v-model="searchkey"
            />
            <a-button
              type="primary"
              style="margin-right: 15px"
              @click="searchOrg"
              >搜索</a-button
            >
            <a-button @click="resetOrg">重置</a-button>
          </div>
        </div>
        <div class="content-main" v-if="orgdata">
          <div class="main-mechanism">
            <h2 class="mechanism-h2">相关机构</h2>
            <ul class="mechanism-ul" :class="{ activeUi: !flag }">
              <li
                v-for="(item, index) in orgdata"
                :key="index"
                class="mechanism-li"
                :class="{ active: currentSort == index }"
                @click="active(index, item)"
              >
                <span>{{ item.key }} {{ item.orgname }}</span>
                <span style="float: right">
                  <span class="span-tag" v-if="(item.type & 8) == 8"
                    >&nbsp;机构职责&nbsp;</span
                  >
                  <span class="span-tag" v-if="(item.type & 4) == 4"
                    >&nbsp;权力清单&nbsp;</span
                  >
                  <span class="span-tag" v-if="(item.type & 2) == 2"
                    >&nbsp;定岗定员定责&nbsp;</span
                  >
                  <span class="span-tag" v-if="(item.type & 1) == 1"
                    >&nbsp;事业单位年报&nbsp;</span
                  >
                  <a-icon
                    type="file-search"
                    style="font-size: 16px; cursor: pointer"
                    @click="active(index, item)"
                  />
                </span>
              </li>
            </ul>
            <div
              @click="changeArrow"
              class="toggleSort"
              v-if="orgdata != null && orgdata.length > 3"
            >
              <span>{{ flag ? "折叠" : "展开" }}</span>
              <a-icon :type="flag ? 'up' : 'down'" />
            </div>
          </div>
        </div>
      </div>
      <a-spin :spinning="loading" class="loading" :delay="50" />
      <!--机构全部内容-->
      <div class="functional-content details" v-if="orgdata">
        <!--机构详情-->
        <div class="main-mechanism" id="mechanism-one">
          <h2 class="mechanism-h2">机构详情——{{ orgMuster.orgname }}</h2>
          <div class="mechanism-div">
            <div class="small-div"></div>
            <div class="small-p">机构详情</div>
          </div>
          <tree-list
            :orgtitle="orgMuster.orgname"
            :dutieslist="dutieslist"
            :childrenlist="childrenlist"
            :inputvalue="keywords"
            :typearr="typearr"
          ></tree-list>
        </div>
        <!-- 权力清单 -->
        <div class="list-power main-mechanism" id="list-two" v-if="qlsx">
          <div class="mechanism-div">
            <div class="small-div"></div>
            <div class="small-p">权力清单</div>
          </div>
          <tree-list
            :qlsxtitle="qlsx.orgname"
            :qlsxlist="qlsx"
            :inputvalue="keywords"
          ></tree-list>
        </div>
        <!-- 定岗定员定责 -->
        <div
          class="list-power main-mechanism"
          id="people-three"
          v-if="dinggang"
        >
          <div class="mechanism-div">
            <div class="small-div"></div>
            <div class="small-p">定岗定员定责</div>
          </div>
          <tree-list
            :dingganglist="dinggang"
            :dinggangtitle="dinggang.orgname"
            :inputvalue="keywords"
          ></tree-list>
        </div>
        <!-- 事业单位年报 -->
        <div
          class="list-power main-mechanism"
          id="work-four"
          v-if="yearReports"
        >
          <div class="mechanism-div">
            <div class="small-div"></div>
            <div class="small-p">事业单位年报</div>
          </div>
          <ul v-for="(item, iex) in yearReports" :key="iex">
            <h4>{{ item.orgname }}</h4>
            <span style="font-weight: 700"
              >【{{ item.year }}|{{ item.purpose }}】</span
            >
            <li class="work-li">
              <span
                style="width: 91%; color: rgba(0, 0, 0, 0.5)"
                v-html="brightenKeyword(item.content)"
              ></span>
              <div class="ul-a-button">
                <a-button>查看详情</a-button>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="main-image" v-else>
        <empty-data :tips="warningtext" />
      </div>
    </div>
    <!--组织选择-->
    <a-modal
      title="单位名称选择"
      v-model="orgVisible"
      :width="800"
      :bodyStyle="{ height: '600px', padding: '0' }"
      :footer="null"
    >
      <org-user-select
        mode="org"
        :max-select="100"
        :root-selectable="true"
        :selected="selected"
        @finish="selectOrg"
      />
    </a-modal>
    <!-- 锚点 -->
    <a-card class="anchor-point" v-if="orgdata">
      <a-anchor :getContainer="() => $refs.functionalBody">
        <a-anchor-link href="#header-top" title="顶部" />
        <a-anchor-link
          href="#mechanism-one"
          title="机构职责"
          v-if="dutieslist || childrenlist"
        />
        <a-anchor-link
          href="#list-two"
          title="权力清单"
          v-if="qlsx.length > 0"
        />
        <a-anchor-link
          href="#people-three"
          title="定岗定原定责"
          v-if="dinggang.length > 0"
        />
        <a-anchor-link
          href="#work-four"
          title="事业单位年报"
          v-if="yearReports.length > 0"
        />
      </a-anchor>
    </a-card>
  </div>
</template>
<script>
import { Input, Icon, Button, Modal, Anchor, Card, Spin } from "ant-design-vue";
import OrgUserSelect from "@/framework/components/OrgUserSelect";
import {
  orgfuncdescPost,
  orgfuncdescSearch,
} from "@/person-shaoxing/api/analysis";
import treeList from "./components/treeList";
import { showError } from "@/framework/utils/index";
import EmptyData from "@/framework/components/EmptyData";
export default {
  name: "",
  components: {
    ASpin: Spin,
    AInput: Input,
    AIcon: Icon,
    ACard: Card,
    AButton: Button,
    AModal: Modal,
    AAnchor: Anchor,
    AAnchorLink: Anchor.Link,
    OrgUserSelect,
    treeList,
    EmptyData,
  },
  watch: {
    selected: {
      handler(newValue, oldValue) {
        for (let i = 0; i < newValue.length; i++) {
          if (oldValue[i] != newValue[i]) {
          }
        }
      },
      deep: true,
    },
  },
  data() {
    return {
      dutieslist: [],
      childrenlist: [],
      qlsx: [],
      dinggang: [],
      flag: false,
      yearReports: [],
      currentSort: 0,
      orgdata: null,
      orgValue: undefined,
      orgVisible: false,
      nodelist: [],
      selected: [],
      searchkey: "",
      keywords: "",
      orgMuster: null,
      warningtext: "请选择机构或进行关键字搜索",
      loading: false,
    };
  },
  computed: {
    //职责
    typearr() {
      return this.$store.getters.dict("person.orgfuncdesctype");
    },
  },
  methods: {
    searchOrg() {
      if (this.searchkey == "") {
        this.$notification.warning({
          message: "提示",
          description: "请输入查询内容!",
          duration: 3,
        });
      } else {
        this.loading = true;
        let orgids = [];
        this.nodelist.forEach(function (item) {
          orgids.push(item.orgid);
        });
        let data = {
          orgids: orgids,
          searchkey: this.searchkey,
        };
        orgfuncdescPost(data)
          .then((res) => {
            if (res.result) {
              this.orgdata = res.result;
              this.currentSort = 0;
              this.keywords = this.searchkey;
              this.searchlist(this.orgdata[0], this.searchkey);
              this.orgMuster = this.orgdata[0];
              this.loading = false;
            } else {
              this.loading = false;
              this.warningtext = "该关键词无查询内容";
              this.nodelist = [];
              this.selected = [];
              this.searchkey = "";
              this.orgdata = null;
            }
          })
          .catch((err) => {
            showError(err);
            this.loading = false;
          });
      }
    },
    resetOrg() {
      this.nodelist = [];
      this.selected = [];
      this.searchkey = "";
      this.warningtext = "请选择机构或进行关键字搜索";
    },
    searchlist(data, searchkey) {
      let list = {
        orgid: data.orgid,
        type: data.type,
        searchkey: searchkey,
      };
      orgfuncdescSearch(list)
        .then((res) => {
          document.querySelector("#mechanism-one").scrollIntoView(true);
          if (res.result.orgfuncdesc.duties) {
            this.dutieslist = res.result.orgfuncdesc.duties;
          }
          if (res.result.orgfuncdesc.children) {
            this.childrenlist = res.result.orgfuncdesc.children;
          }
          if (res.result.qlsx) {
            this.qlsx = res.result.qlsx;
          }
          if (res.result.dinggang) {
            this.dinggang = res.result.dinggang;
          }
          if (res.result.yearReport) {
            this.yearReports = res.result.yearReport.yearReports;
          }
        })
        .catch((err) => {
          showError(err);
        });
    },
    //判断搜索记录是否包含某个关键字
    brightenKeyword(content) {
      // inputvalue为搜索框中的value
      let inputvalue = this.keywords;
      let index = content.indexOf(inputvalue);
      if (content.length < 250) {
        const Reg = new RegExp(inputvalue, "g");
        let res = "";
        res = content.replace(
          Reg,
          `<span style="color: #d60002;">${inputvalue}</span>`
        );
        return res;
      } else if (index < 20) {
        let newtext = content.slice(index, index + 125);
        let newcontent = `......${newtext}......`;
        const Reg = new RegExp(inputvalue);
        let res = "";
        res = newcontent.replace(
          Reg,
          `<span style="color: #d60002;">${inputvalue}</span>`
        );
        return res;
      } else {
        let newtext = content.slice(index - 15, index + 225);
        let newcontent = `......${newtext}......`;
        const Reg = new RegExp(inputvalue);
        let res = "";
        res = newcontent.replace(
          Reg,
          `<span style="color: #d60002;">${inputvalue}</span>`
        );
        return res;
      }
    },
    //展开、收起筛选
    changeArrow() {
      this.flag = !this.flag;
    },
    active(index, item) {
      this.currentSort = index;
      this.searchlist(item, this.searchkey);
      this.orgMuster = item;
    },
    orgModelShow() {
      this.orgVisible = true;
    },
    //确定选择的机构
    selectOrg(type, list) {
      this.orgVisible = false;
      if (type == "ok") {
        let orgarr = [];
        list.forEach(function (item) {
          orgarr.push({
            orgid: item._id,
            orgname: item.name,
            name: item.name,
          });
        });
        this.nodelist = orgarr;
        //监听选择的组织
        this.selected = this.nodelist;
      }
    },
  },
};
</script>
<style lang="less" scoped>
.functional-design {
  position: relative;
  height: 100%;
  .flexbox {
    display: flex;
    flex-direction: column;
  }
  .functional {
    height: 100%;
    padding: @layout-space-base;
    overflow-y: auto;
    .functional-content {
      height: auto;
      display: flex;
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -ms-flex-direction: column;
      flex-direction: column;
      overflow: hidden;
      background: @white;
      .content-header {
        display: flex;
        flex-direction: column;
        height: 70px;
        box-shadow: 1px 1px 3px 1px #fdf2f2;
        .header-left {
          float: left;
          margin: auto @layout-space-base;
          .left-icon {
            color: @primary-color;
          }
        }
      }
      .contentbox {
        margin-bottom: 3px;
      }
      .content-main {
        height: auto;
        .main-mechanism {
          margin: @layout-space-base;
          .mechanism-h2 {
            font-weight: 700;
            color: #666666;
          }
          .mechanism-ul {
            .mechanism-li {
              cursor: pointer;
              padding: 0 @layout-space-base;
              border-bottom: 1px dashed #d9d9d9;
              height: 45px;
              span {
                line-height: 45px;
              }
              .span-tag {
                margin-right: @layout-space-base;
                border: 1px solid #d9d9d9;
                border-radius: 2px;
              }
            }
            .active {
              color: @primary-color;
              .span-tag {
                border: 1px solid @primary-color;
              }
            }
          }
          .activeUi {
            height: 135px;
            overflow: hidden;
          }
          .toggleSort {
            margin: auto;
            width: 60px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            span {
              color: @primary-color;
            }
            i {
              margin-left: 5px;
              color: @primary-color;
            }
          }
        }
      }
    }
    .details {
      height: auto;
      margin-top: @layout-space-base;
      .main-mechanism {
        margin: @layout-space-base;
        border-bottom: 1px solid #ededed;
        .mechanism-h2 {
          padding-bottom: @layout-space-base;
          font-weight: 700;
          color: #666666;
          border-bottom: 1px solid #ededed;
        }
        .mechanism-div {
          display: flex;
          align-items: center;
          .small-div {
            width: 5px;
            height: 20px;
            background: @primary-color;
          }
          .small-p {
            font-size: 20px;
            margin-left: 5px;
          }
        }
      }
      .list-power {
        margin-top: 0px;
        .work-li {
          width: 92%;
          justify-content: space-between;
          display: flex;
          min-height: 32px;
        }
        @media screen and(max-width:1440px) {
          .work-li {
            width: 92.6%;
          }
        }
      }
    }
    .main-image {
      background: @white;
      flex: 1;
    }
    .loading {
      position: absolute;
      top: 40%;
      left: 50%;
      margin-left: -10px;
    }
  }
  .anchor-point {
    position: fixed;
    right: 30px;
    top: 44%;
    border-radius: @layout-space-base;
    /deep/.ant-card-body {
      padding: 18px;
    }
  }
}
</style>
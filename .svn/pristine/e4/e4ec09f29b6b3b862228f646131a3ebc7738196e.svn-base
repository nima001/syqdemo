<template>
  <a-collapse v-model="activeKey" :bordered="false" style="background-color: unset;position: relative">
    <a-collapse-panel key="12" header="数据操作">
      <div class="sort">
        <span>排序</span>
        <a-select @change="sortChange" :getPopupContainer="triggerNode => triggerNode.parentNode">
          <a-select-option v-for="item in sortArray" :key="item.value">
            {{ item.label }}
          </a-select-option>
        </a-select>
      </div>
      <a-button class="merge" style="width: 90%" type="primary" ghost @click="showModal">截取</a-button>
      <a-modal
        width="450px"
        title="选择截取区间"
        v-model="showSlideModal"
        :destroyOnClose="true"
        :footer="null"
      >
        <a-slider
          range
          v-model="rangeData"
          :max="interceptLength-1"
          :min="0"
          :default-value="[0, interceptLength-1]"
          :tooltip-visible="showSlideModal"
          @change="range"
        />
        <div :class="[ 'merge', { show: this.isShow() } ]" >
          <span>是否合并剩余项: </span>
          <a-switch v-model="chartData.settings.sort.mergeOther" />
        </div>
      </a-modal>
    </a-collapse-panel>
  </a-collapse>
</template>

<script>
import { Collapse, Button, Select, Switch, Slider } from "ant-design-vue";
import { map } from 'lodash';
import DataSet from '@antv/data-set';
export default {
  props: {
    value: {
      type: Object,
    },
  },
  components: {
    AButton: Button,
    ACollapse: Collapse,
    ASelect: Select,
    ASwitch: Switch,
    ASlider: Slider,
    ASelectOption: Select.Option,
    ACollapsePanel: Collapse.Panel,
  },
  data() {
    return {
      interceptLength: 1,
      showSlideModal: false,
      activeKey: undefined,
      chartData: this.value,
      rangeData: undefined,
      sortArray: [
        { label: "升序", value: "ASC" },
        { label: "降序", value: "DESC" },
        { label: "还原", value: "RECOVER" },
      ],
    };
  },
  watch: {
    chartData: {
      deep: true,
      handler(val) {
        this.$emit("input", val);
      },
    },
    queryData: {
      deep: true,
      handler(val) {
        if(val) {
          this.getLength(val.data);
        }
      }
    },
  },
  computed: {
    queryData() {
      return this.$attrs.queryData;
    },
    muitl() {
      if (this.queryData && this.queryData.data) {
        let { keyCols, valueCols, rows } = this.queryData.data;
        return valueCols.length > 1 || keyCols.length > 1;
      }
    },
    showOptions() {
      if (
        this.chartData.chartType === "pie-chart" ||
        this.chartData.chartType === "ring-chart"
      ) {
        return true;
      } else if (this.chartData.chartType !== "radar-chart") {
        if (!this.muitl) {
          return true;
        }
      }
      return false;
    },
  },
  methods: {
    isShow() {
      if(this.rangeData && this.rangeData[1] - this.rangeData[0] < this.interceptLength - 1) {
        return true
      }else{
        this.chartData.settings.sort.mergeOther = false;
        return false;
      }
    },
    open(key) {
      if (this.activeKey && this.activeKey.length) {
        let index = this.activeKey.indexOf(key);
        if (index >= 0) {
          this.activeKey.splice(index, 1);
        }
      }
    },
    sortChange(val) {
      this.$set(this.chartData.settings.sort, "type", val);
      this.$emit("input", this.chartData);
      this.sort = val;
    },
    range(val) {
      this.$set(this.chartData.settings.sort, "range", val);
      this.$emit("input", this.chartData);
    },
    showModal() {
      if (this.showSlideModal) {
        this.showSlideModal = false;
        return;
      }
      this.showSlideModal = true;
    },
    getLength(data) {
      let { keyCols, valueCols, rows } = data;
      let values = map(valueCols, 'column');
      if(values.length>1) {
        const dv = new DataSet.DataView().source(rows);
        dv.transform({
          type: 'fold',
          fields: values,
          key: 'col',
          value: 'value',
        });
        this.interceptLength = dv.rows.length;
      }else{
        this.interceptLength = rows.length;
      }
    },
  },
};
</script>
<style lang="less" scoped>
.sort {
  display: flex;
  align-items: center;
  .ant-select {
    flex: 1;
    margin-left: @padding-sm;
  }
}
.merge.ant-btn {
  margin-top: 12px;
  margin-left: 24px;
}
/deep/.ant-modal-body {
  padding: 48px 24px;
  height: 150px;
  .merge{
    opacity: 0;
    width: 92%;
    transition: all .3s;
    &.show {
      opacity: 1;
    }
  }
}
</style>

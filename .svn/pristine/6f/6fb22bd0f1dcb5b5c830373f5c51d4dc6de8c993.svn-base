<template>
  <div class="form-select-group">
    <a-form-item
      :label="field.desc"
      :required="!!field.require" 
      :validateStatus="validateStatus"
    >
      <dict-select :dict="field.datasource" style="width: 100%"
        v-model="propValue"
        :allowClear="!field.require"
        @change="onChange"
      />
    </a-form-item>
  </div>
</template>
<script>
import { Form } from "ant-design-vue";
import DictSelect from "@/framework/components/DictSelect";
import get from 'lodash/get';
import set from 'lodash/set';
export default {
  props: {
    field: {
      type: Object,
    },
    data: {
      type: Object
    }
  },
  components: {
    AFormItem: Form.Item,
    DictSelect
  },
  computed: {
    propValue:{
      get(){
        return get(this.data, this.code);
      },
      set(value){
        set(this.data, this.code, value)
      }
    }
  },
  data() {
    return {
      code: this.field['name'],
      validateStatus: undefined,
      propValue: undefined
    };
  },
  methods: {
    validateField(obj){
      return new Promise((resolve, reject) => {
        this.validate((status) => {
          if(status == 'error'){
            reject({code:'form_validate_fail', message: '表单验证失败'});
          }else{
            if(status == 'success'){
              //值undefined时设置为null 才会序列化 需要传key 服务器识别情况数据
              set(obj, this.code, this.propValue === undefined ? null : this.propValue);
            }
            resolve();
          }
        })
      });
    },
    validate(callback){
      let status = undefined;//error 验证失败 success成功
      //TODO 数据格式校验
      if(this.field.require && !this.propValue){
        status = 'error';
      }else{
        status = 'success';
      }
      this.validateStatus = status;
      if(callback){
        callback(status);
      }
    },
    onChange(){
      this.validate();
    }
  }
};
</script>
<style lang="less" scoped>
.ant-form-item {
  margin-bottom: 0;
}
</style>
<template>
  <div class="home-body">
    <div class="left" :style="{width: `${weightWidth}%`}">
       <draggable
        :disabled="this.draggable"
        :force-fallback="true"
        :animation="200"
        v-model="leftWidgets"
        :move="leftmoveEnd"
        @end="dragEnd"
        ghostClass="ghostClass"
        :group="{name: 'menu', put: true}"
      >
        <div v-for="w in leftWidgets" :key="w.id">
          <a-card
            class="widget"
            :title="w.name"
            :bodyStyle="{padding: 0}"
            :bordered="false"
          >
            <div slot="extra" class="extra">
              <router-link class="more" :to="w.moreurl" v-if="w.moreurl">更多</router-link>
              <a-dropdown>
                <a class="ant-dropdown-link" @click="e => e.preventDefault()">
                  <a-icon type="more" class="icon" />
                </a>
                <a-menu slot="overlay" @click="onClick($event,w)">
                  <a-menu-item key="1" style="width: 100px;text-align: center;">删除</a-menu-item>
                </a-menu>
              </a-dropdown>
            </div>
            <component :is="w.componenturi"/>
          </a-card>
        </div>
      </draggable>
      <div  class="move-handle" @mousedown.prevent="drag()"></div>
    </div>
    <div class="right" :style="{width: `${100 - weightWidth}%`}">
      <draggable
        :disabled="this.draggable"
        :force-fallback="true"
        :animation="200"
        v-model="rightWidgets"
        :move="rightmoveEnd"
        @end="dragEnd"
        ghostClass="ghostClass"
        :group="{name: 'menu', put: true}"
      >
        <div v-for="w in rightWidgets" :key="w.id">
          <a-card
            class="widget"
            :title="w.name"
            :bodyStyle="{padding: 0}"
            :bordered="false"
          >
            <div slot="extra" class="extra">
              <router-link :to="w.moreurl" v-if="w.moreurl">更多</router-link>
              <a-dropdown>
                <a class="ant-dropdown-link" @click="e => e.preventDefault()">
                  <a-icon type="more" class="icon" />
                </a>
                <a-menu slot="overlay" @click="onClick($event,w)">
                  <a-menu-item key="1" style="width: 100px;text-align: center;">删除</a-menu-item>
                </a-menu>
              </a-dropdown>
            </div>
            <component :is="w.componenturi"/>
          </a-card>
        </div>
      </draggable>
    </div>
  </div>
</template>
<script>
import { Card, Icon, Dropdown, Menu } from "ant-design-vue";
import draggable from "vuedraggable";
import { showError } from "../../utils/index";
import { getLayout, getWidgets, updateLayout } from "../../api/menu";
import widgets from "../../widgets";

export default {
  components: {
    ACard: Card,
    AIcon: Icon,
    ADropdown: Dropdown,
    AMenu: Menu,
    AMenuItem: Menu.Item,
    ...widgets,
    draggable,
  },
  data() {
    return {
      layout: {
        weight: undefined,
        widgets: undefined,
      },
      leftWidgets: [],
      rightWidgets: [],
      draggable:false,
    };
  },
  computed: {
    weightWidth() {
      if (this.layout.weight) {
        return Math.max(Math.min(this.layout.weight * 100, 70), 30);
      } else {
        return 50;
      }
    },
  },
  created() {
    this.loadLayout();
    // this.loadWidgets();
  },
  methods: {
    //获取首页需要展示的组件
    loadLayout() {
      getLayout()
        .then(({ result }) => {
          this.layout = result;
          this.rightWidgets = this.layout.widgets.filter(
            (item) => item.layout === 0
          );
          this.leftWidgets = this.layout.widgets.filter(
            (item) => item.layout === 1
          );
        })
        .catch((error) => {
          showError(error);
        });
    },
    leftmoveEnd(evt) {
      if (this.leftWidgets.length < 2) {
        return false;
      } else {
        evt.draggedContext.element.layout = evt.relatedContext.element.layout;
      }
    },
    rightmoveEnd(evt) {
      if (this.rightWidgets.length < 2) {
        return false;
      } else {
        evt.draggedContext.element.layout = evt.relatedContext.element.layout;
      }
    },
    dragEnd(evt) {
      this.layout.widgets = [...this.leftWidgets, ...this.rightWidgets];
      this.layout.widgets.forEach((item, index) => {
        item.orderby = index + 1;
      });
      let data = this.layout;
      // updateLayout(data)
      //   .then((res) => {})
      //   .catch((error) => {
      //     showError(error);
      //   });
    },
    //获取全部的组件
    // loadWidgets(){
    //   getWidgets().then(res=>{
    //   })
    // }
    onClick(event, w) {
      if (event.key == 1) {
        this.layout.widgets.splice(w.orderby - 1, 1);
        this.layout.widgets.forEach((item, index) => {
          item.orderby = index + 1;
        });
        let data = this.layout;
        updateLayout(data)
          .then((res) => {
            this.$message.success("删除成功");
            this.loadLayout();
          })
          .catch((error) => {
            showError(error);
          });
      }
    },
    drag(){
      let that = this;
      let startX = event.x;
      let sw = this.layout.weight;//获取左边区域占领比例
      document.onmousemove = function(){
        this.draggable = true;//禁用排序拖动
        let moveX =  event.x - startX;
        //左边占比加上移动占比等于左边总占比
        that.layout.weight =  Math.min(610,sw + moveX/document.documentElement.clientWidth);
      };
      document.onmouseup = function(){
        this.draggable = false;//启用排序拖动
        document.onmousemove = null;
        document.onmouseup = null;
      };
      return false;
    }
  },
};
</script>
<style lang="less" scoped>
.home-body {
  padding: @layout-space-base;
  display: flex;
  .widget {
    margin-bottom: 10px;
    .extra {
      .more {
        color: @text-color-secondary;
      }
      .ant-dropdown-link {
        .icon {
          padding-left: 10px;
          font-size: 18px;
          color: @text-color-secondary;
        }
      }
    }
  }
  .ghostClass {
    opacity: 0 !important;
  }
  .left {
    position: relative;
    width: 50%;
    padding-right: @layout-space-base / 2;
    & .move-handle{
      cursor: w-resize;
      position: absolute;
      width: @layout-space-base;
      height: 100%;
      top: 0;
      right: 0;
    }
  }
  .right {
    padding-left: @layout-space-base / 2;
    width: 50%;
  }
  /deep/.ant-card-head {
    height: 41px;
    min-height: 41px;
  }
}
</style>

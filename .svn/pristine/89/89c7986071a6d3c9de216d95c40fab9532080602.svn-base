<!-- 转让应用 -->
<template>
  <div>
    <a-modal
      title="转让应用"
      :visible="transfervisible"
      :confirm-loading="transferLoading"
      @ok="transferOk"
      @cancel="transferCancel"
      width="600px"
      okText="转让应用"
    >
      <a-form
        class="transfer-form"
        :form="form"
        :label-col="{ span: 5 }"
        :wrapper-col="{ span: 13 }"
        labelAlign="left"
      >
        <a-form-item class="transferdata" label="转让码">
          <a-input
            ref="tranferscodeFocus"
            v-decorator="[
                  'code',
                  { rules: [{ required: true, message: '请输入转让码' }] },
                ]"
          >
            <a-icon slot="suffix" type="plus" title="生成转让码" @click="generyTcode" />
          </a-input>
        </a-form-item>

        <a-form-item class="transferdata" label="是否短信通知">
          <a-switch
            checked-children="是"
            un-checked-children="否"
            v-decorator="['inform',{ valuePropName: 'checked',initialValue:true}]"
            @change="smsInform"
          />
        </a-form-item>

        <div v-if="smsInformFlag">
          <a-form-item class="transferdata" label="手机号">
            <a-input
              v-decorator="[
                    'phone',
                    { rules: [{ required: true, message: '请输入手机号' }] },
                  ]"
              @blur="validatePhoneBlur"
            ></a-input>
          </a-form-item>

          <!-- <a-form-item label="短信模板" class="transferdata">
            <a-select
              v-decorator="[
                  'msgtemplate',
                  { rules: [{ required: true, message: '请选择应用转让提示信息' }] },
                ]"
              placeholder="应用转让提示信息"
            >
              <a-select-option value="1">应用转让提示信息</a-select-option>
            </a-select>
          </a-form-item> -->
          <!-- <a-form-item label="短信内容" class="transferdata">
            <a-input
              type="textarea"
              v-decorator="['description']"
              :auto-size="{ minRows: 3, maxRows: 7 }"
            />
          </a-form-item> -->
        </div>
      </a-form>
    </a-modal>
  </div>
</template>
<script>
import { Select, Input, Modal, Form, Icon, Switch } from "ant-design-vue";
import { generateTransfercode, transfer } from "@/dev/api/app";
import { transfaceAppTmpl } from "@/dev/api/idm";
import { showError } from "@/framework/utils";

export default {
  props: {
    transfervisible: Boolean,
    transferId: Number
  },
  data() {
    return {
      boo: true,
      transferLoading: false,
      smsInformFlag: true,
      form: this.$form.createForm(this)
    };
  },
  components: {
    AInput: Input,
    ASelect: Select,
    ASelectOption: Select.Option,
    AForm: Form,
    AIcon: Icon,
    ASwitch: Switch,
    AFormItem: Form.Item
  },
  created() {
    this.getSMSTmpl();
  },
  computed: {
    // smstmplkey() {
    //   return this.$store.getters.getConfig("transfer.smstmpl");
    // },

  },
  methods: {
    // 转让页面关闭
    transferCancel() {
      this.$emit("closeTransfer", false);
      this.form.resetFields();
      this.smsInformFlag = this.form.getFieldValue("inform");
    },
    //生成转让码
    generyTcode() {
      this.$refs.tranferscodeFocus.focus();
      generateTransfercode()
        .then(res => {
          this.form.setFieldsValue({ code: res.result });
        })
        .catch(error => {
          showError(error);
        });
    },
    // getSMSTmpl(){
    //   let data = "groupby="+this.smstmplkey;
    //   transfaceAppTmpl(data)
    //   .then((res)=>{
    //     console.log(res.result);
    //   })
    //   .catch((err)=>{
    //     showError(err);
    //   });

    // },
    // 转让应用
    transferOk() {
      this.form.validateFields((err, values) => {
        if (!err) {
          if (!this.smsInformFlag || this.boo) {
            values.appid = this.transferId;
            this.transferLoading = true;
            transfer(values)
              .then(res => {
                this.$notification.success({
                  message: "提示",
                  description: "转让成功",
                  duration: 3
                });
                this.transferLoading = false;
                this.$emit("closeTransfer", false);
                this.form.resetFields();
                this.smsInformFlag = this.form.getFieldValue("inform");
              })
              .catch(error => {
                showError(error);
                this.transferLoading = false;
              });
          }
        }
      });
    },
    //是否开启短信通知
    smsInform(checked) {
      this.smsInformFlag = checked;
    },
    // 联系方式正则
    validatePhoneBlur(e) {
      const validatePhoneReg = /^1[34578]\d{9}$/;
      const validatePhone = /^(\d{3,4}-)?\d{6,8}$/;
      if (
        !validatePhone.test(e.target.value) &&
        !validatePhoneReg.test(e.target.value)
      ) {
        if (this.boo) {
          this.boo = false;
        }
        const arr = [
          {
            message: "您输入的手机格式不正确!",
            field: e.target.id
          }
        ];
        this.form.setFields({
          [e.target.id]: { value: e.target.value, errors: arr }
        });
      } else {
        if (!this.boo) {
          this.boo = true;
        }
      }
    }
  }
};
</script>
<style lang="less" scoped>
.transfer-form {
  margin-left: 30px;
}
</style>
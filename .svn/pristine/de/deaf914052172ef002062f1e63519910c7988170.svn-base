<template>
  <div class="wrap" :id="id">
    <a-spin :spinning="loading" v-if="loading"></a-spin>
  </div>
</template>

<script>
import { orgStaffReport } from "@/person-shaoxing/api/orgStaffReport";
import DataSet from "@antv/data-set";
import { Chart } from "@antv/g2";
import { showError } from "@framework/utils";
import { Spin } from "ant-design-vue";
// 雷达图
export default {
  data() {
    return {
      id: Math.random()
        .toString(36)
        .substr(2),
      list: [],
      plot: undefined,
      valueCols: [],
      loading: true,
      color: ["#d15456", "#5488d1"]
    };
  },
  props: {
    unittype: {
      required: true
    }
  },
  components: {
    ASpin: Spin
  },
  watch: {
    unittype(v) {
      if (this.plot) {
        this.plot.destroy();
      }
      this.getData(v, "");
    }
  },
  computed: {
    yAxisKey() {
      if (this.unittype == 1) {
        return [
          "_id@organization.statistic.xzbzhds",
          "_id@organization.statistic.xzbzsys"
        ];
      } else {
        return [
          "_id@organization.statistic.syhdbzs",
          "_id@organization.statistic.sybzsys"
        ];
      }
    }
  },
  mounted() {
    this.getData(this.unittype, "");
  },
  methods: {
    getData(unittype, district) {
      this.loading = true;
      orgStaffReport(unittype, district)
        .then(res => {
          this.createData(res.result, () => {
            this.draw();
          });
        })
        .catch(err => {
          showError(err);
        })
        .finally(() => {
          this.loading = false;
        });
    },
    createData(dataTable, fn) {
      let { keyCols, rows, valueCols } = dataTable;
      valueCols = valueCols.filter(item => {
        if (this.yAxisKey.includes(item.key)) {
          return item;
        }
      });
      this.valueCols = valueCols;
      let key = keyCols[0];
      this.list = rows.map(item => {
        return {
          item: item[key.column],
          [valueCols[0].showname]: item[valueCols[0].column],
          [valueCols[1].showname]: item[valueCols[1].column]
        };
      });
      fn();
    },
    draw() {
      const { DataView } = DataSet;
      const dv = new DataView().source(this.list);
      dv.transform({
        type: "fold",
        fields: [this.valueCols[0].showname, this.valueCols[1].showname], // 展开字段集
        key: "name",
        value: "value"
      });
      const chart = new Chart({
        container: this.id,
        autoFit: true
      });
      chart.data(dv.rows);
      chart.scale("value", {
        nice: true,
        min: 0
      });
      chart.coordinate("polar", {
        radius: 0.8
      });
      chart.tooltip({
        shared: true,
        showCrosshairs: true,
        crosshairs: {
          line: {
            style: {
              lineDash: [4, 4],
              stroke: "#333"
            }
          }
        }
      });
      chart.axis("item", {
        line: null,
        tickLine: null,
        grid: {
          line: {
            style: {
              lineDash: null
            }
          }
        }
      });
      chart.axis("value", {
        line: null,
        tickLine: null,
        grid: {
          line: {
            type: "line",
            style: {
              lineDash: null
            }
          },
          closed: true,
          alternateColor: "#f5f5f5"
        }
      });
      chart.legend({ position: "right-top" });
      chart
        .line()
        .position("item*value")
        .color("name", this.color)
        .size(2);
      chart
        .point()
        .position("item*value")
        .color("name", this.color)
        .label("value", {
          labelEmit: true,
          offset: 10,
          layout: {
            type: "fixed-overlap"
          }
        })
        .shape("circle")
        .size(4)
        .style({
          stroke: "#fff",
          lineWidth: 1,
          fillOpacity: 1
        });

      chart.render();
      this.plot = chart;
    }
  }
};
</script>
<style lang='less' scoped>
.wrap {
  width: 100%;
  height: 100%;
  position: relative;
  .ant-spin {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
  }
}
</style>
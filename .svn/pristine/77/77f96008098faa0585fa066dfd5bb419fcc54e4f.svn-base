<template>
  <div :style="{position:'relative'}">
      <div class="container" v-if="data&&data.length==2">
        <div class="ring" v-for="item in data">
          <RingChart
            :data="item"
            :settings="{
              canvas: { width: 300, height: 400 },
              padding: [-90, 0, 0, -50],
              radius: 0.5,
              innerRadius: 0.8,
              tooltip: {
                visible: true,
              },
              color: [
                '#F2A54D',
                '#60B4F5',
                '#F84848',
                '#DF6EA3',
                '#6EDF75',
                '#A66DF5',
                '#C3F1CE',
                '#A0A4F5',
              ],
              infoText: {
                title: item.rows[0].k0,
                offsetY: -20,
                style: { fontSize: 18, fill: '#fff', textAlign: 'center' },
              },
              contentStyle: {
                offsetY: 10,
                fontSize: 25,
                fill: '#fff',
                textAlign: 'center',
              },
            }"
          >
            <template v-slot:customLegend="props">
              <div class="legend">
                <p class="title">{{ title }}{{item.name}}</p>
                <ul>
                  <li v-for="(row, index) in item.rows" @click="showUserList(title,row)">
                    <span class="left">
                      <span :style="{ background: props[index] }" class="spot"></span>
                      <span>{{ row.k0 }}</span>
                    </span>
                    <span>{{ row.v0||0 }}</span>
                  </li>
                </ul>
              </div>
            </template>
          </RingChart>
        </div>
      </div>
      <DialogBox v-model="showList">
        <UserList :district="districtCode" :unittypes="unittypes" :age="age" :ageop="ageop" :education="education" :leaderpostlevel="leaderpostlevel"/>
      </DialogBox>
  </div>
</template>
<script>
import DialogBox from "../components/DialogBox";
import UserList from "./UserList";
import RingChart from "@person/components/chart/RingChart";
import { includes } from 'lodash';

export default {
  components: {
    DialogBox,
    RingChart,
    UserList,
  },
  props: {
    districtCode: String,
    showChart: Boolean,
    title: String,
    type: String,
    dataList: {
      type: Array,
    },
  },
  data() {
    return {
      data: undefined,
      showList: false,
      age: undefined,
      ageop: undefined,
      unittypes: [],
      education: undefined,
      leaderpostlevel: undefined,
    };
  },
  computed: {
    leaderpostlevels() {
      let v = this.$store.getters.dict('usermanage.user.leaderpostlevel');
      return v;
    },
    unittype() {
      let v = this.$store.getters.dict('usermanage.org.unittype');
      return v;
    },
    educations() {
      let v = this.$store.getters.dict('usermanage.user.education');
      return v;
    }
  },
  watch: {
    leaderpostlevels(val) {
      return val;
    },
    unittype(val) {
      return val;
    },
    educations(val) {
      return val;
    },
    districtCode(val) {
      return val;
    },
    dataList(val) {
      this.data = val;
    },
  },
  mounted() {
    this.showList = false;
  },
  methods: {
    createFilter(value) {
      let edu = this.educations.filter((item)=>item.text==value);
      if(edu&&edu.length) {
        this.education = edu[0].value;
      }else if(includes(value, '岁')){
        this.createAge(value);
      }
    },
    createAge(age) {
      let op = undefined;
      let value = undefined;
      if(includes(age,'岁及以上')) {
        op = 'gte';
        value = (age).split('岁及以上')[0];
      }else if(includes(age,'-')) {
        op = 'between';
        let string = (age).split('岁')[0];
        value = [string.split('-')[0], string.split('-')[1]];
      }else if(includes(age,'岁及以下')) {
        op = 'lte';
        value = (age).split('岁及以下')[0];
      }
      this.ageop = op;
      this.age = value;
    },
    createUnittypes() {
      let v = undefined;
      if(this.type=='dz') {
        v=1;
      }else if(this.type=='zf') {
        v=2;
      }else if(this.type=='sy') {
        v=3;
      }
      if(v) {
        let array = this.unittype.filter((item)=>item.value==v);
        this.unittypes[0]  = array[0].value;
      }else{
        this.unittypes = undefined;
      }
    },
    showUserList(title,row) {//条件=顶部标题的 年龄/学历 + 点击项（年龄/学历）+ 单位类型
      this.createFilter(title);
      if(!this.age) {
        this.createAge(row.k0);
      }else if(!this.education) {
        let edu = this.educations.filter((item)=>item.text==row.k0);
        if(edu.length) {
          this.education = edu[0].value;
        }else{
          this.education = undefined;
        }
      }
      let leaders = this.leaderpostlevels.filter((item)=>item.text==row.k0);
      if(leaders.length) {
        this.leaderpostlevel = leaders[0].value;
      }else if(!leaders.length) {
        this.leaderpostlevel = undefined;
      }
      this.createUnittypes();
      this.showList = true;
    },
  },
};
</script>
<style lang="less" scoped>
.container {
  height: 90%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  .ring {
    flex: 1;
    display: flex;
    align-items: center;
    position: relative;
    /deep/.ring-chart {
      height: 300px;
      .chart {
        width: 60%;
        position: relative;
        top: 50%;
        &::before {
          content: "";
          background: #242b5b;
          position: absolute;
          width: 210px;
          height: 210px;
          left: 14%;
          top: 12.5%;
          border-radius: 50%;
        }
      }
    }
    .title {
      margin-bottom: 20px;
      font-size: 1.4em;
      font-weight: 600;
    }
    .legend {
      width: 50%;
      height: 500px;
      padding: @padding-lg;
      text-align: left;
      position: absolute;
      top: 15%;
      left: 45%;
      color: fade(#fff, 80%);
      display: flex;
      flex-direction: column;
      .title {
        text-align: center;
        position: relative;
        left: -50%;
      }
      ul {
        width: 100%;
        height: 500px;
        padding: @padding-md @padding-xs @padding-md 50px;
        margin: 0;
        margin-left: auto;
        background: url("../../../assets/img/screen/age-education-bg.png") no-repeat;
        background-size: cover;
        overflow-y: scroll;
        li {
          width: 100%;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          font-size: 1.2em;
          cursor: pointer;
          user-select: none;
          .left {
            width: 70%;
            margin-right: 10px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            .spot {
              width: 10px;
              height: 10px;
              margin-right: 10px;
              border-radius: @border-radius-base;
              display: inline-block;
            }
          }
          &:hover {
            color: #fff;
          }
          span:last-child {
            text-align: right;
          }
          & > span:last-child {
            color: #02e7ef;
          }
        }
      }
    }
  }
}
</style>

<template>
  <div class="form-panel">
    <div :class="{'form-body': true, 'anchor': tables && tables.length > 1}" ref="formBody">
      <div v-for="item in tables" :key="item.key" :id="item.key">
        <ChartTableStaff
          :value="data" 
          :name="item.name" 
          :chartCols="item.chartCols" 
          :tableCols="item.tableCols"
          :warnCols="item.warnCols"
          :unittype="unittype" 
          :district="district"
        />
      </div>
    </div>
    <a-anchor v-if="tables && tables.length > 1" wrapperClass="form-anchor" :getContainer="() => $refs.formBody">
      <a-anchor-link v-for="item in tables" :href="`#${item.key}`" :title="item.name" :key="item.key"/>
    </a-anchor>
  </div>
</template>
<script>
import { Anchor, Table, Input } from "ant-design-vue";
import ChartTable from './ChartTable'
import ChartTableStaff from './ChartTableStaff'
import { orgStaffReport } from '@/person-shaoxing/api/orgStaffReport'
import { showError } from '@framework/utils'

/**
 * 机构编制数监测
 */
export default {
  components: {
    AAnchor: Anchor,
    AAnchorLink: Anchor.Link,
    ChartTable, ChartTableStaff
  },
  props: {
    unittype: {
      type: Number,
      required: true,
    },
    district: {
      type: String,
    }
  },
  data(){
    return {
      data: undefined,
      tables: undefined,
    }
  },
  computed: {
    params(){
      return { unittype: this.unittype, district: this.district}
    }
  },
  watch: {
    params(v){
      this.tables = null;
      this.loadData(this.params);
    }
  },
  created(){
    this.loadData(this.params);
  },
  methods: {
    loadData({unittype, district}){
      orgStaffReport(unittype, district).then(({result}) => {
        if(district){
          this.tables = [{ 
            key: 'all', 
            name: (this.unittype == 1 ? '机关编制预警' : '事业编制预警') ,
            chartCols: [this.unittype == 1 ? '_id@organization.statistic.dzqjgbzcks' : '_id@organization.statistic.sybzcks'],
            warnCols: [this.unittype == 1 ? '_id@organization.statistic.dzqjgbzcks' : '_id@organization.statistic.sybzcks'],
          }];
        }else{
          if(unittype == 1){
            this.tables = this.getXzTable(result);
          }else{
            this.tables = [{ 
              key: 'all', 
              name: '事业编制超编预警',
              chartCols: ['_id@organization.statistic.sybzcks'],
              warnCols: ['_id@organization.statistic.sybzcks'],
            }];
          }
        }
        this.data = result;
      }).catch(error => {
        showError(error);
      });
    },
    getXzTable(data){
      let { keyCols, valueCols, rows } = data; 
      return [{ 
        key: 'all', 
        name: '机关编制超编预警',
        chartCols: ['_id@organization.statistic.dzqjgbzcks'],
        warnCols: ['_id@organization.statistic.dzqjgbzcks'],
        tableCols: [
          '_id@organization.statistic.zgbzzl',
          '_id@organization.statistic.xzdfpbzs',
          '_id@organization.statistic.jghdbzs',
          '_id@organization.statistic.jgbzsyzj',
          '_id@organization.statistic.dzqjgbzcks',
        ]
      }, { 
        key: 'xz', 
        name: '行政编制超编预警',
        chartCols: ['_id@organization.statistic.xzbzcks'],
        warnCols: ['_id@organization.statistic.xzbzcks'],
        tableCols: [
          '_id@organization.statistic.xzbzhds',
          '_id@organization.statistic.xzbzsys',
          '_id@organization.statistic.xzbzcks'
        ]
      }, { 
        key: 'zx', 
        name: '专项编制超编预警',
        chartCols: ['_id@organization.statistic.zxbzcks'],
        warnCols: ['_id@organization.statistic.zxbzcks'],
        tableCols: [
          '_id@organization.statistic.zfzxbz_hd',
          '_id@organization.statistic.zfzxbz_sy',
          '_id@organization.statistic.zxbzcks'
        ]
      }, { 
        key: 'hq', 
        name: '后勤编制超编预警',
        chartCols: ['_id@organization.statistic.gqbzcks'],
        warnCols: ['_id@organization.statistic.gqbzcks'],
        tableCols: [
          '_id@organization.statistic.gqbz',
          '_id@organization.statistic.gqbz_sy',
          '_id@organization.statistic.gqbzcks'
        ]
      }];
    },
  }
}
</script>
<style lang="less" scoped>
.form-panel{
  position: relative;
  height: 100%;
  .form-body {
    height: 100%;
    padding: 0 @content-padding-h;
    overflow-y: scroll;
    &.anchor{
      padding-right: 200px + @content-padding-h;
    }
  }
  /deep/.form-anchor {
    position: absolute;
    top: 50px;
    right: @content-padding-h;
    width: 180px;
    padding-left: 5px;
  }
}
</style>
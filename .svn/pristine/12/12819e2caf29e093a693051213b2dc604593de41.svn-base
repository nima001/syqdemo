<template>
  <div class="user-form-job-tabpanel">
    <div class="toolbar" v-if="hasPermit('/person/org/user/edit')">
      <template v-if="edit">
        <a-button type="primary" @click="save">保存</a-button>
        <a-button @click="edit=false" style="margin-left: 10px;">取消</a-button>
      </template>
      <a-button v-else type="primary" @click="edit=true">编辑</a-button>
    </div>
    <div class="body">
      <user-form :data="user" :form="form" :edit="edit" ref="userForm"/>
    </div>
  </div>
</template>
<script>
import { Button } from "ant-design-vue";
import Form from "../form/Form";
import { updateUser } from "@/person/api/user";
import { showError } from "@/framework/utils/index";

export default {
  props: {
    user: {
      type: Object,
      default: () => ({}),
    },
  },
  components: {
    AButton: Button,
    UserForm: Form,
  },
  data(){
    return {
      edit: false,
      form: undefined,
    }
  },
  created(){
    this.form = this.createForm();
  },
  methods: {
     save(){
      this.$refs.userForm.validateFileds().then(data => {
        updateUser(this.user._id, data).then(({result}) => {
          this.edit = false;
          if(result){
            Object.keys(result).forEach(key => {
              this.$set(this.user, key, result[key]);
            })
            this.$message.info('保存成功')
          }
        }).catch(error => {
          showError(error);
        });
      }).catch(error => {
        showError({message: '表单验证失败，请检查表单数据'});
      })
    },
    createForm(){
      return [
        { id: 'wage', title: '工资信息', properties: [
          { label: "岗位类型", code: "job.jobtype", type: 'dict', dict: "usermanage.user.jobtype", span: 1, disable: true },
          { label: "工资级别", code: "treatlevel", type: 'dict', dict: "usermanage.user.treatlevel", span: 1, disable: true },
          { label: "薪级", code: "salarylevel", type: 'dict', dict: "usermanage.user.salarylevel", span: 1, disable: true },
          { label: "享受岗位津贴等级", code: "jobsubsidieslevel", type: 'dict', dict: "usermanage.user.treatlevel", span: 1, disable: true },
          { label: "连续工龄起算时间（不含硕博研）", code: "workyeartime", type: 'date', span: 1, disable: true },
          { label: "连续工龄起算时间（含硕博研）", code: "workyeartimenot", type: 'date', span: 1, disable: true },
          { label: "是否教护", code: "teachornurse", type: 'dict', dict: 'usermanage.user.teachernurse', span: 1 },
          { label: "教育类型", code: "teachertype", type: 'dict', dict: 'usermanage.user.teachertype', span: 1 },
          { label: "工资执行时间", code: "executiontime", type: 'date', span: 1, disable: true },
        ]},
      ]
    }
  }
};
</script>
<style lang="less" scoped>
.user-form-job-tabpanel {
  height: 100%;
  display: flex;
  flex-direction: column;
  & > .toolbar{
    padding: 0 @content-padding-h;
    margin-top: 10px;
  }

  & > .body{
    flex: auto;
    min-height: 0;
    margin: @content-padding-v 0;
  }
}
</style>
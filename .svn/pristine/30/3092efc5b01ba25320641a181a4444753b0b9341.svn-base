<template>
  <div class="report-detail">
    <div class="main">
      <div class="main-top">
        <a-button type="primary" v-if="!this.$route.query.id" @click="saveReport">保存</a-button>
        <a-button type="primary" v-if="!this.$route.query.id" @click="onAdd">变更</a-button>
        <a-button type="primary">一键导出</a-button> 
      </div>
      <div class="main-content">
        <Content v-if="detailData" :content="detailData" />
      </div>
    </div>
    <a-modal
      title="变更"
      v-model="addvisible"
      :width="800"
      :destroyOnClose="true"
      :bodyStyle="{height: '500px'}"
      @ok="addOk"
      @cancel="addCancel">
      <add-report ref="AddReport" :spin="spinning"></add-report>
    </a-modal>
    <a-modal
      title="变更"
      v-model="addvisible"
      :width="800"
      :destroyOnClose="true"
      :bodyStyle="{height: '500px'}"
      @ok="addOk"
      @cancel="addCancel">
      <add-report ref="AddReport" :spin="spinning"></add-report>
    </a-modal>
  </div>
</template>
<script>
import { Button, Modal } from "ant-design-vue";
import AddReport from '@/person-shaoxing/views/assessment/compileAssist/components/AddReport';
import Content from "./components/Content";
import { reportDetail, addReport } from "@/person-shaoxing/api/assessment";
import { showError } from "@/framework/utils/index";
import { loadData } from './components/contentItems';

export default {
  components: {
    AButton: Button,
    AModal: Modal,
    AddReport,
    Content
  },
  computed: {
    assessData() {
      return this.$store.getters.assessData
    }
  },
  data() {
    return {
      detailData: undefined,
      addvisible: false,
      spinning: false
    }
  },
  created() {
    if(this.$route.query.id) {
      this.getData();
    }else{
      this.detailData = this.assessData.details;
    }
  },
  methods: {
    getData() {
      reportDetail(this.$route.query.id)
      .then(({result}) => {
        this.detailData = JSON.parse(result.details);
      })  
      .catch(err => {
        showError(err);
      })
    },
    saveReport() {
      let data = {};
      data.details = JSON.stringify(this.detailData);
      data.configid = this.assessData.configid;
      data.orgname = this.assessData.name;
      addReport(data)
      .then(({result}) =>{
        this.showCloseWindow();
        return;
      })
      .catch(err => {
        showError(err);
      })
    },
    onAdd() {
      this.addvisible = true;
    },
    async addOk() {
      this.spinning = true;
      let value = await this.$refs.AddReport.getFormValue();
      if(value) {
        let data = await loadData(value.target, value.itemArr);
        let assessData = {
          configid: value.content,
          name: value.target.hasOwnProperty('org') ? value.target.org.name : value.target.orgname,
          details: data
        }
        if(data) {
          this.detailData = assessData.details;
          this.spinning= false;
          this.addvisible = false;
        }else{
          this.spinning = false;
        }
      }else{
        this.spinning = false;
      }
    },
    addCancel() {
      this.addvisible = false;
    },
    showCloseWindow(){
      let secondsToGo = 3;
      const modal = Modal.info({
        title: '提示', 
        content: `提交成功，窗口将在 ${secondsToGo} 后自动关闭`,
        okText: '关闭窗口',
        keyboard: false,
        onOk: () => {
          this.$router.push('/person/assessment/compileassist');
          return;
        }
      })
      const interval = setInterval(() => {
        secondsToGo -= 1;
        modal.update({
          content: `提交成功，窗口将在 ${secondsToGo} 后自动关闭`,
        });
      }, 1000);
      setTimeout(() => {
        clearInterval(interval);
        modal.destroy();
        this.$router.push('/person/assessment/compileassist');
      }, secondsToGo * 1000);
    },
  }
}
</script>
<style lang="less" scoped>
.report-detail{
  padding: 10px;
  height: 100%;

  .main{
    display: flex;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -ms-flex-direction: column;
    flex-direction: column;
    overflow: hidden;
    background: @white;
    height: 100%;
    .main-top{
      padding: 18px @content-padding-h @content-padding-h;
      button{
        margin-right: 16px;
      }
    }
    .main-content{
      flex-shrink: 1;
      overflow-y: auto;
    }
  }
}
</style>
const path = require('path')
const glob = require("glob")
const fs = require('fs');
const theme = require('./theme/theme')
const resolveDir = dir => path.join(__dirname, dir)

// // const argv = process.argv; //读取vue-cli-service命名参数
console.log(process.env.npm_config_argv)
const argv = JSON.parse(process.env.npm_config_argv); // 读取npm命名参数
//解析命令行参数，将按照规则添加到process.env配置中
(function(args){
  for(let i = 0; i < args.length; i++){
    let key = args[i];
    if(key.startsWith('--')){
      let value = args[++i];
      key = key.substr(2).replace(/([A-Z])/g,"_$1").toUpperCase();
      console.log(key, value);
      process.env['VUE_APP_' + key] = value;
    }
  }
})(argv.cooked)
// 打包的模块
const installModules = {};
const allModules = glob.sync('./src/*/main.js').map(path => path.split('/')[2]).filter(name => name != 'framework');
const modules = process.env.VUE_APP_MODULES, defaultPlugin = process.env.VUE_APP_PROJECT_PLUGIN;
if (modules) {
  modules.split(',').forEach(name => {
    const [module, plugin] = name.split('-');
    if(installModules[module]){
      throw new Error(`模块 ${module} 重复指定`);
    }
    installModules[module] = {
      plugin: plugin || defaultPlugin
    }
  })
}else{
  allModules.forEach(name => {
    if(name.indexOf('-') <= 0){
      installModules[name] = { plugin: defaultPlugin }
    }
  });
}
Object.keys(installModules).forEach(name => {
  if(allModules.indexOf(name) < 0){
    throw new Error(`模块 ${name} 不存在`);
  }
  const module = installModules[name];
  if(module.plugin){
    const package = name + '-' + module.plugin;
    if(allModules.indexOf(package) >= 0){//二次开发包存在独立main文件
      module.indepMain = true;
    }else if(!fs.existsSync(resolveDir('src/'+package))){
      module.plugin = undefined;
    }
  }
});

process.env.VUE_APP_MODULES = JSON.stringify(installModules);
console.log('打包模块：', installModules);
//前端部署项目地址
let publicPath = '/';
if(process.env.NODE_ENV != 'development'){
  let projectPath = process.env.VUE_APP_PROJECT_PATH;
  if(projectPath === undefined){
    publicPath += process.env.VUE_APP_PROJECT_NAME + '/';
  }else if(projectPath){
    if(projectPath.startsWith('/')){
      publicPath = projectPath;
    }else{
      publicPath += projectPath;
    }
    if(!publicPath.endsWith('/')){
      publicPath += '/';
    }
  }
}
process.env.VUE_APP_PROJECT_PATH = publicPath;

module.exports = {
  publicPath: publicPath,
  lintOnSave: true,
  productionSourceMap: process.env.NODE_ENV == 'development',
  css: {
    loaderOptions: {
      less: {
        javascriptEnabled: true,
        modifyVars: theme[process.env.VUE_APP_THEME] || theme.red
      }
    }
  },
  pluginOptions: {
    'style-resources-loader': {
      preProcessor: 'less',
      patterns: [resolveDir('./theme/index.less')]
    }
  },
  pages: {
    index: {
      entry: 'src/framework/main.js',
      template: 'public/index.html',
      filename: 'index.html',
      chunks: ['chunk-vendors', 'chunk-common', 'index']
    },
    ...Object.fromEntries(Object.keys(installModules).map(module => {
      const { plugin, indepMain } = installModules[module];
      return [module, {
        entry: `src/${plugin && indepMain ? module + '-' + plugin : module}/main.js`,
        template: 'public/index.html',
        filename: `${module}.html`,
        chunks: ['chunk-vendors', 'chunk-common', module]
      }]
    }))
  },
  configureWebpack: {
    devServer: { 
      proxy: {
        '/api': {
          // target: 'http://192.168.1.111:8080/',
          // target: 'http://192.168.1.226:8080/',
          // target: 'http://192.168.1.120:8080/',
          // target: 'http://192.168.1.121:8080/',
          // target: 'http://192.168.1.135:8080/',
          target: 'http://192.168.1.227:8080',
          changeOrigin: true,
          ws: true,
          pathRewrite: {
            '^/api' : ''
          }
        },
      },
      historyApiFallback: { 
        verbose: true, 
        rewrites: [ 
          ...Object.keys(installModules).map(module => {
            return { from: new RegExp(`^\/${module}(\/.*)*$`), to: `/${module}.html`, accept: '*'}
          }),
          { from: /.*/, to: '/index.html', accept: '*'} 
        ] 
      } 
    } 
  },
  chainWebpack: config => {
    //二次开发重写vue
    let srcPath = resolveDir('src');
    config.module.rule('plugin-cover')
      .test((p) => {
        return p.startsWith(srcPath) && (p.endsWith('.vue'))
      })
      .use('plugin-cover-loader')
        .loader('./plugin-cover-loader.js')
        .options({
          srcPath,
          modules: installModules
        }).end();
    //添加控件loader
    config.module.rule('widgets')
      .test(resolveDir('src/framework/widgets/index.js'))
      .use('widget-loader')
        .loader('./widget-loader.js')
        .options({
          modules: installModules
        }).end();
    //自定义svg图标加载
    const iconsPaths = [resolveDir(`src/framework/assets/icons`)];
    Object.keys(installModules).forEach((module) => {
      const { plugin } = installModules[module];
      iconsPaths.push(resolveDir(`src/${module}/assets/icons`));
      if(plugin){
        iconsPaths.push(resolveDir(`src/${module}-${plugin}/assets/icons`));
      }
    });
    config.module.rule('svg').exclude.merge(iconsPaths).end();
    config.module.rule('icons')
      .test(/\.svg$/).include.merge(iconsPaths)
      .end()
      .use('svg-sprite-loader')
        .loader('svg-sprite-loader')
        .options({
          symbolId: '[name]'
        }).end()
    //添加路径别名
    config.resolve.alias
      .set('@', resolveDir('src'))
      .set('@framework', resolveDir('src/framework'))
      .set('@person', resolveDir('src/person'))
      .set('@salary', resolveDir('src/salary'))
      .set('@formdesign', resolveDir('src/formdesign'))
      .set('@workflow', resolveDir('src/workflow'))
  }
}

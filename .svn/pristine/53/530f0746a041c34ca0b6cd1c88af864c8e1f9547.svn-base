<template>
  <!--编制-->
  <div class="report">
    <div class="title">
      <span class="icon bianzhi"></span>
      <span class="text">编制</span>
    </div>
    <div class="cell">
      <div class="cellItem">
        <p>行政编制待分配数</p>
        <div class="num">
          <lcd-font :length="4" :realNumber="(staffInfo.zgbzzl - staffInfo.hdxzbzqygq) | thanZero"></lcd-font>
        </div>
        <div class="type">
          <span class="name">省定</span>
          <span class="number">{{staffInfo.zgbzzl || 0}}</span>
        </div>
        <div class="type">
          <span class="name">核定</span>
          <span class="number">{{staffInfo.hdxzbzqygq || 0}}</span>
        </div>
      </div>
      <div class="cellItem">
        <p>行政机关空编数</p>
        <div
          class="num clickable"
          @click="showDetail({
            title: '行政机关空编数',
            total: 'hdxzbzqygq',
            used: 'hdxzbzqy_sy',
            unittypes: [1, 5, 7],
            field: { code: 'dzqjgbzcks', name: '空编'},
            totalgq: staffInfo.hdxzbzqy - staffInfo.hdxzbzqygq,
            totalbbye: []
          })"
        >
          <lcd-font :length="4" :realNumber="(staffInfo.hdxzbzqy - staffInfo.hdxzbzqy_sy) | thanZero"></lcd-font>
        </div>
        <div class="type">
          <span class="name">核定</span>
          <span class="number">{{staffInfo.hdxzbzqygq || 0}}</span>
        </div>
        <div class="type">
          <span class="name">实有</span>
          <span class="number">{{staffInfo.hdxzbzqy_sy || 0}}</span>
        </div>
      </div>
    </div>
    <div class="cell last">
      <div class="cellItem">
        <p>事业编制待分配数</p>
        <div class="num accent">
          <lcd-font :length="4" :realNumber="(staffInfo.sybzzl - staffInfo.hesybzqy) | thanZero" :realStyle="realStyle"></lcd-font>
        </div>
        <div class="type">
          <span class="name">省定</span>
          <span class="number">{{staffInfo.sybzzl || 0}}</span>
        </div>
        <div class="type">
          <span class="name">核定</span>
          <span class="number">{{staffInfo.hesybzqy || 0}}</span>
        </div>
      </div>
      <div class="cellItem">
        <p>事业单位空编数</p>
        <div
          class="num accent clickable"
          @click="showDetail({
            title: '事业编制空编数',
            total: 'hdsybzbbqy',
            used: 'hdsybzqy_sy',
            unittypes: [2, 3, 11],
            field: {code: 'sybzcks', name: '空编'},
            totalgq: undefined,
            totalbbye: [bbye_bzajfxs||0, bbye_bzajfxs_sy||0]
          })"
        >{{staffInfo.bbye_bzajfxs}}
          <lcd-font :length="4" :realNumber="(staffInfo.hdsybzbbqy - staffInfo.hdsybzqy_sy) | thanZero" :realStyle="realStyle"></lcd-font>
        </div>
        <div class="type">
          <span class="name">核定</span>
          <span class="number">{{staffInfo.hesybzqy || 0}}</span>
        </div>
        <div class="type">
          <span class="name">实有</span>
          <span class="number">{{staffInfo.hdsybzqy_sy || 0}}</span>
        </div>
      </div>
    </div>
    <kong-bian-detail v-model="showDialog" v-bind="detail" />
  </div>
</template>
<script>
import LcdFont from "../components/LcdFont";
import { mixins } from "../components/minxin";
import KongBianDetail from "./KongBianDetail";
import { assign } from 'lodash';
import { query } from "@/person/api/integratedquery";
import { areaStatistics, statistics } from "@/person-shaoxing/api/orgStaffReport";
import { showError } from "@/framework/utils/index";

export default {
  components: { LcdFont, KongBianDetail },
  data() {
    return {
      realStyle: {
        color: "#ffd3a3"
      },
      staffInfo: {},
      bbye_bzajfxs: undefined,
      bbye_bzajfxs_sy: undefined,
      showDialog: false,
      query: {
        target: {id:1},
        nodeid: undefined,
        filter: undefined,
        fields: [
          { key: '_id@organization.statistic.bbye_bzajfxs' },
          { key: '_id@organization.statistic.bbye_bzajfxs_sy' },
        ],
        orders: [{
          orderby: "_id@organization.statistic.bbye_bzajfxs_sy",
          ordertype: "DESC"
        }]
      },
      detail: {
        num: 0,
        total: 0,
        used: 0,
        unittypes: undefined,
        field: undefined,
      }
    };
  },
  mixins: [mixins],
  mounted() {
    this.staffCount(this.dictId);
  },
  watch: {
    dictId(v) {
      this.staffCount(v);
    },
  },
  filters: {
    thanZero(num){
      return num > 0 ? num : 0;
    }
  },
  methods: {
    staffCount(district) {
      /** 
       * bbye_bzajfxs 	//报备员额-编制按经费形式
       * bbye_bzajfxs_sy //报备员额-编制按经费形式实有数
       * zgbzzl     //行政编制省定
       * hdxzbzqygq 
       * hdxzbzqy    //行政编制核定数 
       * hdxzbzqy_sy //行政编制实有数 
       * sybzzl      //事业编省定
       * hdsybzbbqy    //事业核定编制数 
       * hesybzqy
       * hdsybzqy_sy  //事业实有人数
      */
     
      this.$set(this.query,'filter', {op: "and", criteria:[{ field: { key: 'district' }, op: 'eq', value: district }]});
      Promise.all([
        areaStatistics(district, [
          'zgbzzl', "hdxzbzqygq",
          'hdxzbzqy', 'hdxzbzqy_sy',
          'sybzzl', 'hdsybzbbqy', 
          'hesybzqy', 'hdsybzqy_sy',
        ]),
        query({
          ...this.query,
          needtotal: true,
          pagenum: 1,
          pagesize: 1
        })
      ]).then(res=>{
        this.staffInfo = res[0].result;
        this.bbye_bzajfxs = res[1].result.rows[0]['_join0.bbye_bzajfxs'];
        this.bbye_bzajfxs_sy = res[1].result.rows[0]['_join0.bbye_bzajfxs_sy'];
      }).catch(err=>{
        showError(err)
      })
    },
    showDetail({ title, total, used, unittypes, field, totalgq, totalbbye }) {
      this.detail.title = title;
      this.detail.total = this.staffInfo[total];
      this.detail.used = this.staffInfo[used];
      this.detail.unittypes = unittypes;
      this.detail.field = field;
      this.detail.totalgq = totalgq;
      this.detail.totalbbye = totalbbye;
      this.showDialog = true;
    }
  }
};
</script>
<style lang='less' scoped>
.report {
  .title {
    display: flex;
    align-items: center;
    .icon {
      width: 24px;
      height: 24px;
      &.jigou {
        background: url("../img/jigou.png");
      }
      &.bianzhi {
        background: url("../img/bainzhi.png");
      }
      &.zhishu {
        background: url("../img/zhishu.png");
      }
    }
    .text {
      width: 80px;
      height: 80px;
      line-height: 80px;
      text-align: center;
      background: url("../img/text_bj.png");
      font-size: 20px;
      font-family: Microsoft YaHei;
      font-weight: bold;
      color: #ffffff;
      -webkit-text-stroke: 1 #66d9ec;
      opacity: 0.9;
      margin-left: -8px;
    }
  }
  .cell {
    display: flex;
    width: 270px;
    justify-content: space-between;
    &.last {
      margin-top: 20px;
    }
    .cellItem {
      p {
        margin: 0px;
        height: 22px;
        line-height: 22px;
        font-size: 16px;
        font-family: Microsoft YaHei;
        font-weight: 400;
        color: #fff;
        opacity: 0.8;
      }
      .num {
        width: 110px;
        height: 48px;
        margin: 4px auto;
        text-align: center;
        &.clickable {
          cursor: pointer;
        }
      }
      .type {
        width: 110px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 4px auto;
        padding: 0px 5px;
        .name {
          height: 21px;
          font-size: 16px;
          font-family: Microsoft YaHei;
          font-weight: 400;
          line-height: 21px;
          color: #ffffff;
          opacity: 0.6;
        }
        .number {
          height: 18px;
          font-size: 16px;
          font-family: Arial;
          font-weight: 400;
          line-height: 18px;
          color: #ffffff;
          opacity: 0.6;
          flex: 1;
          text-align: right;
        }
      }
    }
  }
}
</style>